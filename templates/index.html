<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ham Radio Conditions</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Real-time ham radio propagation conditions, solar weather, and live spots">
    <meta name="theme-color" content="#3B82F6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ham Radio">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Safari-specific meta tags -->
    <meta name="apple-touch-fullscreen" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    
    <!-- Cache control for Safari -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- App Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="/static/icons/icon-72x72.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/icons/icon-72x72.png">
    <link rel="apple-touch-icon" href="/static/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/static/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="167x167" href="/static/icons/icon-152x152.png">
    
    <!-- Stylesheets -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* Professional Design System */
        :root {
            --primary-blue: #2563EB;
            --primary-blue-dark: #1D4ED8;
            --success-green: #059669;
            --warning-yellow: #D97706;
            --danger-red: #DC2626;
            --purple-accent: #7C3AED;
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-400: #9CA3AF;
            --gray-500: #6B7280;
            --gray-600: #4B5563;
            --gray-700: #374151;
            --gray-800: #1F2937;
            --gray-900: #111827;
            --gray-950: #030712;
        }

        /* Professional Card Design */
        .card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            border-color: rgba(255, 255, 255, 0.15);
        }

        /* Professional Typography */
        .font-display {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 700;
            letter-spacing: -0.025em;
        }

        .font-heading {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        .font-body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 400;
            line-height: 1.6;
        }

        /* Enhanced Status Indicators */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-excellent {
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        .status-good {
            background: linear-gradient(135deg, #3B82F6, #2563EB);
            color: white;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .status-fair {
            background: linear-gradient(135deg, #F59E0B, #D97706);
            color: white;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
        }

        .status-poor {
            background: linear-gradient(135deg, #EF4444, #DC2626);
            color: white;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }

        /* Professional Band Condition Colors */
        .condition-good { 
            color: #10B981 !important; 
            font-weight: 600 !important;
            text-shadow: 0 0 12px rgba(16, 185, 129, 0.4) !important;
        }
        .condition-fair { 
            color: #F59E0B !important; 
            font-weight: 600 !important;
            text-shadow: 0 0 12px rgba(245, 158, 11, 0.4) !important;
        }
        .condition-poor { 
            color: #EF4444 !important; 
            font-weight: 600 !important;
            text-shadow: 0 0 12px rgba(239, 68, 68, 0.4) !important;
        }
        
        /* Professional Icon System */
        .icon-solar { 
            color: #F59E0B; 
            filter: drop-shadow(0 0 8px rgba(245, 158, 11, 0.3));
        }
        .icon-band { 
            color: #3B82F6; 
            filter: drop-shadow(0 0 8px rgba(59, 130, 246, 0.3));
        }
        .icon-weather { 
            color: #10B981; 
            filter: drop-shadow(0 0 8px rgba(16, 185, 129, 0.3));
        }
        .icon-dxcc { 
            color: #8B5CF6; 
            filter: drop-shadow(0 0 8px rgba(139, 92, 246, 0.3));
        }
        .icon-spots { 
            color: #EC4899; 
            filter: drop-shadow(0 0 8px rgba(236, 72, 153, 0.3));
        }
        .icon-propagation { 
            color: #8B5CF6; 
            filter: drop-shadow(0 0 8px rgba(139, 92, 246, 0.3));
        }
        
        .section-icon {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .section-icon:hover {
            transform: scale(1.15) rotate(5deg);
            filter: brightness(1.2);
        }

        /* Professional Loading Animation */
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 3px solid #EC4899;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
            box-shadow: 0 0 12px rgba(236, 72, 153, 0.3);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Professional Propagation Quality Classes */
        .propagation-excellent { 
            color: #10B981; 
            text-shadow: 0 0 8px rgba(16, 185, 129, 0.3);
        }
        .propagation-good { 
            color: #3B82F6; 
            text-shadow: 0 0 8px rgba(59, 130, 246, 0.3);
        }
        .propagation-fair { 
            color: #F59E0B; 
            text-shadow: 0 0 8px rgba(245, 158, 11, 0.3);
        }
        .propagation-poor { 
            color: #EF4444; 
            text-shadow: 0 0 8px rgba(239, 68, 68, 0.3);
        }

        /* Professional Data Cards */
        .data-card {
            background: linear-gradient(135deg, rgba(31, 41, 55, 0.8) 0%, rgba(17, 24, 39, 0.9) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .data-card:hover {
            background: linear-gradient(135deg, rgba(31, 41, 55, 0.9) 0%, rgba(17, 24, 39, 1) 100%);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        /* Professional Progress Bars */
        .progress-bar {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 9999px;
            height: 8px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 9999px;
            transition: width 0.5s ease;
            background: linear-gradient(90deg, #10B981, #059669);
        }

        /* Professional Buttons */
        .btn-primary {
            background: linear-gradient(135deg, #3B82F6, #2563EB);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #2563EB, #1D4ED8);
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6B7280, #4B5563);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #4B5563, #374151);
            transform: translateY(-1px);
        }

        /* Professional Table Styling */
        .table-professional {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
        }

        .table-professional th {
            background: linear-gradient(135deg, rgba(31, 41, 55, 0.9), rgba(17, 24, 39, 0.95));
            color: #F3F4F6;
            font-weight: 600;
            padding: 1rem;
            text-align: left;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .table-professional td {
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: background-color 0.2s ease;
        }

        .table-professional tr:hover td {
            background: rgba(255, 255, 255, 0.02);
        }

        /* Professional Grid Layout */
        .grid-professional {
            display: grid;
            gap: 1.5rem;
        }

        /* Professional Spacing */
        .space-professional > * + * {
            margin-top: 1.5rem;
        }

        /* PWA specific styles */
        @media (display-mode: standalone) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
        }

        /* Professional Responsive Design */
        @media (max-width: 768px) {
            .card {
                border-radius: 12px;
            }
            
            .data-card {
                padding: 1rem;
            }
        }

        /* Priority indicators */
        .priority-high {
            border-left: 4px solid #EF4444;
        }
        
        .priority-medium {
            border-left: 4px solid #F59E0B;
        }
        
        .priority-low {
            border-left: 4px solid #10B981;
        }

        /* Current conditions highlight */
        .current-conditions {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(37, 99, 235, 0.05) 100%);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        /* Future predictions highlight */
        .future-predictions {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(124, 58, 237, 0.05) 100%);
            border: 1px solid rgba(139, 92, 246, 0.2);
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- Hidden data element -->
    <script id="data" type="application/json">
        {{ data|tojson|safe }}
    </script>

    <div class="container mx-auto px-4 py-8">
        <!-- Header with Current Status -->
        <header class="text-center mb-8">
            <div class="flex items-center justify-between mb-6">
                <div></div>
                <h1 class="text-4xl font-display text-white">Ham Radio Conditions</h1>
                <div></div>
            </div>
            <div class="space-y-2">
                <p class="text-gray-300 font-body" id="timestamp"></p>
                <p class="text-gray-400 font-body" id="location"></p>
            </div>
        </header>

        <!-- Current Conditions Section -->
        <div class="mb-8">
            <h2 class="text-2xl font-heading mb-4 flex items-center">
                <i class="fas fa-satellite-dish mr-3 section-icon icon-propagation text-2xl"></i>
                <span class="text-white">Current Conditions</span>
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Solar Conditions -->
                <div class="card current-conditions rounded-lg p-4">
                    <h3 class="text-lg font-heading mb-3 flex items-center">
                        <i class="fas fa-sun mr-2 icon-solar"></i>
                        <span>Solar</span>
                    </h3>
                    <div id="solar-conditions" class="space-y-2 text-sm"></div>
                </div>

                <!-- MUF & Propagation -->
                <div class="card current-conditions rounded-lg p-4">
                    <h3 class="text-lg font-heading mb-3 flex items-center">
                        <i class="fas fa-broadcast-tower mr-2 icon-propagation"></i>
                        <span>Propagation</span>
                    </h3>
                    <div id="propagation-current" class="space-y-2 text-sm"></div>
                </div>

                <!-- Best Bands -->
                <div class="card current-conditions rounded-lg p-4">
                    <h3 class="text-lg font-heading mb-3 flex items-center">
                        <i class="fas fa-signal mr-2 icon-band"></i>
                        <span>Best Bands</span>
                    </h3>
                    <div id="best-bands-current" class="space-y-2 text-sm"></div>
                </div>

                <!-- Weather -->
                <div class="card current-conditions rounded-lg p-4">
                    <h3 class="text-lg font-heading mb-3 flex items-center">
                        <i class="fas fa-cloud-sun mr-2 icon-weather"></i>
                        <span>Weather</span>
                    </h3>
                    <div id="weather-conditions" class="space-y-2 text-sm"></div>
                </div>
            </div>
        </div>

        <!-- Future Predictions & Analysis Section -->
        <div class="mb-8">
            <h2 class="text-2xl font-heading mb-4 flex items-center">
                <i class="fas fa-chart-line mr-3 section-icon icon-propagation text-2xl"></i>
                <span class="text-white">Propagation Analysis & Forecast</span>
            </h2>
            
            <div class="space-y-6">
                <!-- Executive Summary -->
                <div class="card future-predictions rounded-lg p-6">
                    <h3 class="text-xl font-heading mb-4 flex items-center">
                        <i class="fas fa-clipboard-list mr-3 text-blue-400"></i>
                        <span>Executive Summary</span>
                    </h3>
                    <div id="executive-summary" class="space-y-3">
                        <div class="text-gray-300 text-sm">Loading summary...</div>
                    </div>
                </div>
                
                <!-- Solar Cycle Analysis -->
                <div class="card future-predictions rounded-lg p-6">
                    <h3 class="text-xl font-heading mb-4 flex items-center">
                        <i class="fas fa-chart-area mr-3 text-purple-400"></i>
                        <span>Solar Cycle Analysis</span>
                    </h3>
                    <div id="solar-cycle-info" class="space-y-3"></div>
                </div>
                
                <!-- Operating Strategy -->
                <div class="card future-predictions rounded-lg p-6">
                    <h3 class="text-xl font-heading mb-4 flex items-center">
                        <i class="fas fa-lightbulb mr-3 text-yellow-400"></i>
                        <span>Operating Strategy & Recommendations</span>
                    </h3>
                    <div id="recommendations" class="space-y-3"></div>
                </div>
                
                <!-- Risk Assessment -->
                <div class="card future-predictions rounded-lg p-6">
                    <h3 class="text-xl font-heading mb-4 flex items-center">
                        <i class="fas fa-exclamation-triangle mr-3 text-orange-400"></i>
                        <span>Risk Assessment & Warnings</span>
                    </h3>
                    <div id="risk-assessment" class="space-y-3">
                        <div class="text-gray-300 text-sm">Analyzing conditions...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Band Conditions -->
        <div class="mb-8">
            <h2 class="text-2xl font-heading mb-4 flex items-center">
                <i class="fas fa-signal mr-3 section-icon icon-band text-2xl"></i>
                <span class="text-white">Band-by-Band Conditions</span>
            </h2>
            
            <div class="card rounded-lg p-6">
                <div id="band-conditions-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4"></div>
            </div>
        </div>

        <!-- Live Activity -->
        <div class="mb-8">
            <h2 class="text-2xl font-heading mb-4 flex items-center">
                <i class="fas fa-broadcast-tower mr-3 section-icon icon-spots text-2xl"></i>
                <span class="text-white">Live Activity</span>
                <span id="spots-loading" class="loading-spinner ml-3" style="display: none;"></span>
                <span id="spots-status" class="ml-2 text-sm text-gray-400">Ready</span>
            </h2>
            
            <div class="card rounded-lg p-6">
                <div id="live-activity">
                    <div id="activity-summary" class="mb-6">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="data-card">
                                <div class="text-gray-400 font-body text-sm mb-2">Total Spots</div>
                                <div class="text-xl font-heading text-white">-</div>
                            </div>
                            <div class="data-card">
                                <div class="text-gray-400 font-body text-sm mb-2">Active Bands</div>
                                <div class="text-xl font-heading text-white">-</div>
                            </div>
                            <div class="data-card">
                                <div class="text-gray-400 font-body text-sm mb-2">Active Modes</div>
                                <div class="text-xl font-heading text-white">-</div>
                            </div>
                            <div class="data-card">
                                <div class="text-gray-400 font-body text-sm mb-2">Active DXCC</div>
                                <div class="text-xl font-heading text-white">-</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="table-professional min-w-full">
                            <thead>
                                <tr class="text-left">
                                    <th class="px-4 py-3 font-heading">Time</th>
                                    <th class="px-4 py-3 font-heading">Callsign</th>
                                    <th class="px-4 py-3 font-heading">Frequency</th>
                                    <th class="px-4 py-3 font-heading">Mode</th>
                                    <th class="px-4 py-3 font-heading">DXCC</th>
                                    <th class="px-4 py-3 font-heading">Source</th>
                                    <th class="px-4 py-3 font-heading">Comment</th>
                                </tr>
                            </thead>
                            <tbody id="spots-table-body">
                                <tr>
                                    <td colspan="7" class="px-4 py-2 text-center text-gray-400">
                                        Loading spots data...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <footer class="mt-16 pt-8 border-t border-gray-800">
            <div class="container mx-auto px-4">
                <div class="flex flex-col md:flex-row justify-between items-center text-center md:text-left">
                    <div class="text-gray-500 text-sm mb-4 md:mb-0">
                        <span>Ham Radio Conditions</span>
                        <span class="mx-2">•</span>
                        <span id="footer-version">v2.1.0</span>
                        <span class="mx-2">•</span>
                        <span id="footer-build-date">2024-12-19</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button onclick="checkForUpdates()" 
                                class="text-gray-500 hover:text-gray-300 text-sm transition-colors">
                            <i class="fas fa-sync-alt mr-1"></i>Check Updates
                        </button>
                        <button onclick="showFullChangelog()" 
                                class="text-gray-500 hover:text-gray-300 text-sm transition-colors">
                            <i class="fas fa-history mr-1"></i>Changelog
                        </button>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <script>
        // Global Safari detection
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

        // Cache DOM elements
        const timestampEl = document.getElementById('timestamp');
        const locationEl = document.getElementById('location');
        const solarDiv = document.getElementById('solar-conditions');
        const propagationCurrentDiv = document.getElementById('propagation-current');
        const bestBandsCurrentDiv = document.getElementById('best-bands-current');
        const bandDiv = document.getElementById('band-conditions-grid');
        const weatherDiv = document.getElementById('weather-conditions');
        const recommendationsDiv = document.getElementById('recommendations');
        const solarCycleDiv = document.getElementById('solar-cycle-info');
        const activityDiv = document.getElementById('live-activity');
        const summaryDiv = document.getElementById('activity-summary');
        const tableBody = document.getElementById('spots-table-body');

        // Helper: Safely set innerHTML
        function safeSetHTML(el, html) {
            if (el) el.innerHTML = html;
        }

        // Helper: Format value
        function formatValue(key, value) {
            if (key === 'sfi') {
                const cleanValue = value.toString().replace(' SFI', '');
                return cleanValue;
            }
            if (key === 'a_index') {
                const cleanValue = value.toString().replace('A-Index: ', '');
                return cleanValue;
            }
            if (key === 'k_index') {
                const cleanValue = value.toString().replace('K-Index: ', '');
                return cleanValue;
            }
            return value;
        }

        // Helper: Condition class
        function updateConditionClass(condition) {
            if (typeof condition !== 'string') return '';
            condition = condition.toLowerCase();
            if (condition.includes('good')) return 'condition-good';
            if (condition.includes('fair')) return 'condition-fair';
            if (condition.includes('poor')) return 'condition-poor';
            return '';
        }

        // Helper: Propagation quality class
        function getPropagationQualityClass(quality) {
            if (typeof quality !== 'string') return '';
            quality = quality.toLowerCase();
            if (quality === 'excellent') return 'propagation-excellent';
            if (quality === 'good') return 'propagation-good';
            if (quality === 'fair') return 'propagation-fair';
            if (quality === 'poor') return 'propagation-poor';
            return '';
        }

        // Helper: Get priority class
        function getPriorityClass(priority) {
            if (priority >= 8) return 'priority-high';
            if (priority >= 5) return 'priority-medium';
            return 'priority-low';
        }

        // UI update functions
        function updateTimestampAndLocation(data) {
            if (timestampEl) timestampEl.textContent = `Last Updated: ${data.timestamp}`;
            if (locationEl) {
                const locationName = data.propagation_summary?.location?.location_name || data.location;
                locationEl.textContent = `Location: ${locationName}`;
            }
        }

        function updateSolarConditions(data) {
            if (!solarDiv) return;
            
            const displayFields = ['sfi', 'a_index', 'k_index', 'aurora', 'sunspots', 'xray'];
            
            safeSetHTML(solarDiv, displayFields
                .filter(key => data.solar_conditions[key] !== undefined)
                .map(key => {
                    const label = key === 'sfi' ? 'SFI' : 
                                 key === 'a_index' ? 'A-Index' : 
                                 key === 'k_index' ? 'K-Index' : 
                                 key.replace('_', ' ').toUpperCase();
                    return `
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">${label}</span>
                            <span class="font-semibold">${formatValue(key, data.solar_conditions[key])}</span>
                        </div>
                    `;
                }).join(''));
        }

        function updatePropagationCurrent(data) {
            if (!propagationCurrentDiv || !data.propagation_summary) return;
            
            const summary = data.propagation_summary;
            const params = summary.propagation_parameters || {};
            
            safeSetHTML(propagationCurrentDiv, `
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">MUF:</span>
                        <span class="font-semibold text-lg">${params.muf || 'N/A'} MHz</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Quality:</span>
                        <span class="font-semibold ${getPropagationQualityClass(params.quality)}">${params.quality || 'N/A'}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Day/Night:</span>
                        <span class="font-semibold">${summary.day_night || 'N/A'}</span>
                    </div>
                </div>
            `);
        }

        function updateBestBandsCurrent(data) {
            if (!bestBandsCurrentDiv || !data.propagation_summary) return;
            
            const summary = data.propagation_summary;
            const params = summary.propagation_parameters || {};
            const bestBands = params.best_bands || [];
            
            safeSetHTML(bestBandsCurrentDiv, `
                <div class="space-y-2">
                    <div class="text-gray-400 text-sm">Top Bands:</div>
                    <div class="font-semibold text-blue-300">${bestBands.slice(0, 3).join(', ') || 'N/A'}</div>
                    <div class="text-gray-400 text-sm">MUF Source:</div>
                    <div class="text-xs text-gray-300">${params.muf_source || 'Traditional'}</div>
                    <div class="text-gray-400 text-sm">Skip Distances:</div>
                    <div class="text-xs space-y-1">
                        ${Object.entries(params.skip_distances || {}).slice(0, 3).map(([band, dist]) => 
                            `<div class="flex justify-between">
                                <span class="text-blue-300">${band}:</span>
                                <span class="font-mono">${dist}</span>
                            </div>`
                        ).join('')}
                    </div>
                </div>
            `);
        }

        function updateBandConditions(data) {
            if (!bandDiv) return;
            
            if (!data.propagation_summary || !data.propagation_summary.band_conditions) {
                safeSetHTML(bandDiv, '<p class="text-gray-400">Band conditions not available</p>');
                return;
            }
            
            const bandConditions = data.propagation_summary.band_conditions;
            const bandOrder = ['6m', '10m', '12m', '15m', '17m', '20m', '30m', '40m', '80m', '160m'];
            
            const sortedBands = Object.entries(bandConditions).sort(([bandA], [bandB]) => {
                const normalizedA = bandA.toLowerCase().trim();
                const normalizedB = bandB.toLowerCase().trim();
                
                function findBandIndex(bandName) {
                    let index = bandOrder.findIndex(band => bandName === band.toLowerCase());
                    if (index !== -1) return index;
                    
                    index = bandOrder.findIndex(band => bandName === band.replace('m', '').toLowerCase());
                    if (index !== -1) return index;
                    
                    const numberMatch = bandName.match(/^(\d+)/);
                    if (numberMatch) {
                        const number = numberMatch[1];
                        index = bandOrder.findIndex(band => band.replace('m', '') === number);
                        if (index !== -1) return index;
                    }
                    
                    index = bandOrder.findIndex(band => band.toLowerCase().includes(bandName) || bandName.includes(band.toLowerCase()));
                    if (index !== -1) return index;
                    
                    return -1;
                }
                
                const indexA = findBandIndex(normalizedA);
                const indexB = findBandIndex(normalizedB);
                
                if (indexA !== -1 && indexB !== -1) {
                    return indexA - indexB;
                }
                
                if (indexA !== -1) return -1;
                if (indexB !== -1) return 1;
                
                return normalizedA.localeCompare(normalizedB);
            });
            
            const bandHtml = sortedBands.map(([bandName, conditions]) => {
                const dayClass = `${(conditions.day_rating || '').toLowerCase()}-condition`;
                const nightClass = `${(conditions.night_rating || '').toLowerCase()}-condition`;
                
                const getColor = (rating) => {
                    if (rating === 'Good') return '#10B981';
                    if (rating === 'Fair') return '#F59E0B';
                    if (rating === 'Poor') return '#EF4444';
                    return '#6B7280';
                };
                
                const dayColor = getColor(conditions.day_rating);
                const nightColor = getColor(conditions.night_rating);
                
                return `
                <div class="bg-gray-800 p-3 rounded-lg">
                    <div class="text-gray-400 font-semibold">${bandName}</div>
                    <div class="grid grid-cols-2 gap-2 mt-2">
                        <div>
                            <span class="text-xs text-gray-400">Day:</span>
                            <span class="ml-1 ${dayClass}" style="color: ${dayColor} !important; font-weight: 600;">${conditions.day_rating || 'N/A'}</span>
                        </div>
                        <div>
                            <span class="text-xs text-gray-400">Night:</span>
                            <span class="ml-1 ${nightClass}" style="color: ${nightColor} !important; font-weight: 600;">${conditions.night_rating || 'N/A'}</span>
                        </div>
                    </div>
                </div>
            `}).join('');
            
            safeSetHTML(bandDiv, bandHtml);
        }

        function updateWeatherConditions(data) {
            if (!weatherDiv) return;
            if (data.weather_conditions) {
                const w = data.weather_conditions;
                safeSetHTML(weatherDiv, `
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Location:</span>
                            <span class="font-semibold">${w.city && w.state ? `${w.city}, ${w.state}` : 'N/A'}</span>
                        </div>
                        ${Object.entries(w)
                            .filter(([key]) => !['source', 'city', 'state'].includes(key))
                            .map(([key, value]) => `
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-400">${key.replace('_', ' ').toUpperCase()}</span>
                                    <span class="font-semibold">${value}</span>
                                </div>
                            `).join('')}
                    </div>
                `);
            } else {
                safeSetHTML(weatherDiv, '<p class="text-gray-400">Weather data not available</p>');
            }
        }

        function updateRecommendations(data) {
            if (!recommendationsDiv || !data.propagation_summary) return;
            
            const summary = data.propagation_summary;
            const params = summary.propagation_parameters || {};
            const solarCycle = summary.solar_cycle || {};
            const recommendations = summary.recommendations || [];
            const bestBands = params.best_bands || [];
            const muf = parseFloat(params.muf) || 0;
            const quality = params.quality || 'Unknown';
            const dayNight = summary.day_night || 'Unknown';
            
            // Create a strategic operating plan
            const strategy = createOperatingStrategy({
                muf, quality, bestBands, dayNight, solarCycle, recommendations
            });
            
            safeSetHTML(recommendationsDiv, strategy);
        }

        function createOperatingStrategy(data) {
            const { muf, quality, bestBands, dayNight, solarCycle, recommendations } = data;
            
            // Determine overall strategy based on conditions
            let overallStrategy = '';
            let strategyColor = '';
            
            if (quality === 'Excellent' || muf > 25) {
                overallStrategy = 'AGGRESSIVE DX OPERATION';
                strategyColor = 'text-green-400';
            } else if (quality === 'Good' || muf > 15) {
                overallStrategy = 'MODERATE DX OPERATION';
                strategyColor = 'text-blue-400';
            } else if (quality === 'Fair' || muf > 10) {
                overallStrategy = 'CONSERVATIVE DX OPERATION';
                strategyColor = 'text-yellow-400';
            } else {
                overallStrategy = 'LOCAL OPERATION FOCUS';
                strategyColor = 'text-red-400';
            }
            
            return `
                <div class="space-y-6">
                    <!-- Strategic Overview -->
                    <div class="bg-gray-800 p-4 rounded-lg border-l-4 border-blue-500">
                        <div class="text-sm text-gray-400 mb-2">STRATEGIC ANALYSIS</div>
                        <div class="space-y-3">
                            <div class="text-lg font-bold ${strategyColor} mb-2">${overallStrategy}</div>
                            
                            <!-- MUF Analysis -->
                            <div class="bg-gray-700 p-3 rounded-lg">
                                <div class="text-sm text-blue-300 font-semibold mb-1">MUF Analysis</div>
                                <div class="text-xs text-gray-300">
                                    Current MUF of ${muf} MHz indicates ${muf > 20 ? 'excellent' : muf > 15 ? 'good' : muf > 10 ? 'moderate' : 'poor'} ionospheric conditions. 
                                    ${muf > 20 ? 'This high MUF allows operation on multiple bands with strong signal propagation and minimal absorption losses.' : 
                                    muf > 15 ? 'This MUF supports reliable continental DX with good signal strength on mid-range bands.' : 
                                    muf > 10 ? 'This moderate MUF limits DX range but provides stable regional communication.' : 
                                    'This low MUF severely restricts long-distance communication, requiring focus on local and regional contacts.'}
                                </div>
                            </div>
                            
                            <!-- Propagation Quality Impact -->
                            <div class="bg-gray-700 p-3 rounded-lg">
                                <div class="text-sm text-blue-300 font-semibold mb-1">Propagation Quality Impact</div>
                                <div class="text-xs text-gray-300">
                                    ${quality === 'Excellent' ? 'Excellent propagation quality means minimal signal degradation, low noise levels, and stable ionospheric layers. This creates optimal conditions for long-distance communication.' :
                                    quality === 'Good' ? 'Good propagation quality indicates stable ionospheric conditions with moderate signal strength and acceptable noise levels. DX contacts are achievable with proper antenna setup.' :
                                    quality === 'Fair' ? 'Fair propagation quality suggests some ionospheric instability with variable signal strength. Careful frequency selection and timing are important for successful contacts.' :
                                    'Poor propagation quality indicates significant ionospheric disturbances, high noise levels, and unstable conditions. Focus on local contacts and wait for conditions to improve.'}
                                </div>
                            </div>
                            
                            <!-- Time-of-Day Considerations -->
                            <div class="bg-gray-700 p-3 rounded-lg">
                                <div class="text-sm text-blue-300 font-semibold mb-1">Time-of-Day Considerations</div>
                                <div class="text-xs text-gray-300">
                                    ${dayNight === 'Day' ? 'Daytime operation benefits from strong F2 layer ionization, providing reliable long-distance propagation on higher frequency bands. The D layer is present but manageable with proper frequency selection.' :
                                    'Nighttime operation occurs without D layer absorption, allowing lower frequency bands to open up for regional communication. However, F2 layer ionization decreases, limiting high-frequency DX opportunities.'}
                                </div>
                            </div>
                            
                            <!-- Strategic Rationale -->
                            <div class="bg-gray-700 p-3 rounded-lg">
                                <div class="text-sm text-blue-300 font-semibold mb-1">Why This Strategy?</div>
                                <div class="text-xs text-gray-300">
                                    ${overallStrategy === 'AGGRESSIVE DX OPERATION' ? 'High MUF and excellent conditions allow maximum exploitation of propagation opportunities. Use full power, directional antennas, and focus on global DX contacts while conditions remain favorable.' :
                                    overallStrategy === 'MODERATE DX OPERATION' ? 'Good conditions support reliable DX operation with moderate power requirements. Balance between DX achievement and power efficiency, focusing on continental contacts.' :
                                    overallStrategy === 'CONSERVATIVE DX OPERATION' ? 'Moderate conditions require careful frequency and timing selection. Use lower power and focus on regional contacts with occasional DX opportunities.' :
                                    'Poor conditions limit communication options. Focus on local contacts, antenna testing, and preparation for when conditions improve. This is not the time for DX attempts.'}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Band Strategy Analysis -->
                    <div class="space-y-3">
                        <div class="text-sm text-gray-400 font-semibold">BAND STRATEGY ANALYSIS</div>
                        <div class="bg-gray-800 p-4 rounded-lg">
                            ${createBandStrategyAnalysis(bestBands, muf, dayNight)}
                        </div>
                    </div>
                    
                    <!-- Band Strategy -->
                    <div class="space-y-3">
                        <div class="text-sm text-gray-400 font-semibold">BAND STRATEGY</div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            ${createBandStrategy(bestBands, muf, dayNight)}
                        </div>
                    </div>
                    
                    <!-- Operating Tactics -->
                    <div class="space-y-3">
                        <div class="text-sm text-gray-400 font-semibold">OPERATING TACTICS</div>
                        <div class="space-y-2">
                            ${createOperatingTactics(muf, quality, dayNight, solarCycle)}
                        </div>
                    </div>
                    
                    <!-- Time-Based Strategy -->
                    <div class="space-y-3">
                        <div class="text-sm text-gray-400 font-semibold">TIME-BASED STRATEGY</div>
                        <div class="bg-gray-800 p-3 rounded-lg">
                            ${createTimeBasedStrategy(dayNight, muf, solarCycle)}
                        </div>
                    </div>
                    
                    <!-- Success Metrics -->
                    <div class="space-y-3">
                        <div class="text-sm text-gray-400 font-semibold">SUCCESS METRICS</div>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div class="bg-gray-800 p-3 rounded-lg">
                                <div class="text-gray-400">Target MUF</div>
                                <div class="font-semibold">${muf > 20 ? '>20 MHz' : muf > 15 ? '>15 MHz' : muf > 10 ? '>10 MHz' : 'Local Only'}</div>
                            </div>
                            <div class="bg-gray-800 p-3 rounded-lg">
                                <div class="text-gray-400">Expected Range</div>
                        <div class="font-semibold">${muf > 20 ? 'Global DX' : muf > 15 ? 'Continental' : muf > 10 ? 'Regional' : 'Local'}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function createBandStrategy(bestBands, muf, dayNight) {
            if (!bestBands || bestBands.length === 0) {
                return '<div class="text-gray-400 text-sm">No band strategy available</div>';
            }
            
            const primaryBands = bestBands.slice(0, 3);
            const secondaryBands = bestBands.slice(3, 5);
            
            // Create band frequency mapping
            const bandFreqs = {
                '160m': 1.8, '80m': 3.5, '40m': 7.0, '30m': 10.1,
                '20m': 14.0, '17m': 18.1, '15m': 21.0, '12m': 24.9, '10m': 28.0, '6m': 50.0
            };
            
            // Analyze why bands are ranked as they are
            const analyzeBand = (band) => {
                const freq = bandFreqs[band];
                if (!freq || !muf) return '';
                
                const mufRatio = freq / muf;
                if (mufRatio <= 0.8) return ' (Excellent - well below MUF)';
                if (mufRatio <= 1.0) return ' (Very Good - near MUF)';
                if (mufRatio <= 1.2) return ' (Good - slightly above MUF)';
                if (mufRatio <= 1.5) return ' (Moderate - above MUF)';
                return ' (Poor - well above MUF)';
            };
            
            return `
                <div class="bg-gray-800 p-3 rounded-lg">
                    <div class="text-sm text-blue-300 font-semibold mb-2">Primary Bands (Focus 80% of time)</div>
                    <div class="space-y-1">
                        ${primaryBands.map(band => `
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-300">${band}</span>
                                <span class="text-xs text-gray-400">${bandFreqs[band] || 'N/A'} MHz${analyzeBand(band)}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ${secondaryBands.length > 0 ? `
                <div class="bg-gray-800 p-3 rounded-lg">
                    <div class="text-sm text-yellow-300 font-semibold mb-2">Secondary Bands (Backup & Testing)</div>
                    <div class="space-y-1">
                        ${secondaryBands.map(band => `
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-300">${band}</span>
                                <span class="text-xs text-gray-400">${bandFreqs[band] || 'N/A'} MHz${analyzeBand(band)}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
                <div class="bg-gray-700 p-2 rounded-lg">
                    <div class="text-xs text-gray-400 text-center">
                        MUF: ${muf} MHz | Strategy based on frequency vs MUF ratio
                    </div>
                </div>
            `;
        }

        function createOperatingTactics(muf, quality, dayNight, solarCycle) {
            const tactics = [];
            
            // MUF-based tactics
            if (muf > 20) {
                tactics.push({
                    tactic: 'High Power DX Operation',
                    description: 'Use maximum power for long-distance contacts',
                    icon: 'fas fa-satellite-dish',
                    color: 'text-green-400'
                });
            } else if (muf > 15) {
                tactics.push({
                    tactic: 'Moderate Power DX',
                    description: 'Use 100-200W for continental contacts',
                    icon: 'fas fa-broadcast-tower',
                    color: 'text-blue-400'
                });
            } else if (muf > 10) {
                tactics.push({
                    tactic: 'Low Power Regional',
                    description: 'Use 50-100W for regional contacts',
                    icon: 'fas fa-signal',
                    color: 'text-yellow-400'
                });
            } else {
                tactics.push({
                    tactic: 'Local Operation',
                    description: 'Focus on local contacts and testing',
                    icon: 'fas fa-home',
                    color: 'text-red-400'
                });
            }
            
            // Time-based tactics
            if (dayNight === 'Day') {
                tactics.push({
                    tactic: 'F2 Layer Exploitation',
                    description: 'Take advantage of daytime F2 layer for DX',
                    icon: 'fas fa-sun',
                    color: 'text-yellow-400'
                });
            } else {
                tactics.push({
                    tactic: 'D Layer Absence',
                    description: 'Use lower bands effectively at night',
                    icon: 'fas fa-moon',
                    color: 'text-blue-400'
                });
            }
            
            // Solar cycle tactics
            if (solarCycle.phase && solarCycle.phase.includes('Maximum')) {
                tactics.push({
                    tactic: 'Solar Maximum Advantage',
                    description: 'Exploit high ionization for all-band DX',
                    icon: 'fas fa-chart-line',
                    color: 'text-purple-400'
                });
            }
            
            return tactics.map(tactic => `
                <div class="bg-gray-800 p-3 rounded-lg border-l-4 border-gray-600">
                    <div class="flex items-center mb-2">
                        <i class="${tactic.icon} ${tactic.color} mr-2"></i>
                        <span class="font-semibold text-sm">${tactic.tactic}</span>
                    </div>
                    <div class="text-xs text-gray-300">${tactic.description}</div>
                </div>
            `).join('');
        }

        function createBandStrategyAnalysis(bestBands, muf, dayNight) {
            // Define band characteristics and scoring factors
            const bandInfo = {
                '160m': { freq: 1.8, day_optimal: false, night_optimal: true, weather_impact: 'low' },
                '80m': { freq: 3.5, day_optimal: false, night_optimal: true, weather_impact: 'low' },
                '40m': { freq: 7.0, day_optimal: false, night_optimal: true, weather_impact: 'low' },
                '30m': { freq: 10.1, day_optimal: true, night_optimal: false, weather_impact: 'medium' },
                '20m': { freq: 14.0, day_optimal: true, night_optimal: false, weather_impact: 'medium' },
                '17m': { freq: 18.1, day_optimal: true, night_optimal: false, weather_impact: 'medium' },
                '15m': { freq: 21.0, day_optimal: true, night_optimal: false, weather_impact: 'medium' },
                '12m': { freq: 24.9, day_optimal: true, night_optimal: false, weather_impact: 'high' },
                '10m': { freq: 28.0, day_optimal: true, night_optimal: false, weather_impact: 'high' },
                '6m': { freq: 50.0, day_optimal: true, night_optimal: false, weather_impact: 'very_high' }
            };
            
            // Calculate strategic analysis for each band
            const analysis = Object.keys(bandInfo).map(band => {
                const info = bandInfo[band];
                const mufRatio = info.freq / muf;
                const isSelected = bestBands.includes(band);
                const timeOptimal = (dayNight === 'Day' && info.day_optimal) || 
                                   (dayNight === 'Night' && info.night_optimal);
                
                // Calculate strategic score components
                let mufScore = 0;
                let timeScore = 0;
                let weatherScore = 0;
                let totalScore = 0;
                
                // MUF scoring (highest priority)
                if (mufRatio <= 0.3) mufScore = 45;      // Very well below MUF
                else if (mufRatio <= 0.5) mufScore = 42; // Well below MUF
                else if (mufRatio <= 0.7) mufScore = 38; // Below MUF
                else if (mufRatio <= 0.9) mufScore = 35; // Near MUF
                else if (mufRatio <= 1.0) mufScore = 40; // At MUF (optimal)
                else if (mufRatio <= 1.2) mufScore = 25; // Slightly above MUF
                else if (mufRatio <= 1.5) mufScore = 15; // Above MUF
                else mufScore = 5;                        // Well above MUF
                
                // Time optimization scoring
                if (timeOptimal) timeScore = 40;
                else if (dayNight === 'Day' && info.day_optimal === false) timeScore = 20;
                else if (dayNight === 'Night' && info.night_optimal === false) timeScore = 20;
                else timeScore = 30;
                
                // Weather impact scoring
                switch(info.weather_impact) {
                    case 'very_high': weatherScore = 35; break;
                    case 'high': weatherScore = 30; break;
                    case 'medium': weatherScore = 25; break;
                    case 'low': weatherScore = 20; break;
                    default: weatherScore = 25;
                }
                
                totalScore = mufScore + timeScore + weatherScore;
                
                return {
                    band,
                    info,
                    mufRatio,
                    isSelected,
                    timeOptimal,
                    mufScore,
                    timeScore,
                    weatherScore,
                    totalScore
                };
            }).sort((a, b) => b.totalScore - a.totalScore);
            
            // Generate analysis display
            const analysisRows = analysis.map(band => {
                const statusClass = band.isSelected ? 'border-green-500 bg-green-900/20' : 'border-gray-600 bg-gray-700/20';
                const rankClass = band.isSelected ? 'text-green-400 font-bold' : 'text-gray-400';
                const rank = analysis.findIndex(b => b.band === band.band) + 1;
                
                return `
                    <div class="border-l-4 ${statusClass} bg-gray-700/20 p-3 rounded-r-lg">
                        <div class="flex justify-between items-center mb-2">
                            <div class="font-semibold text-white">${band.band}</div>
                            <div class="text-xs ${rankClass}">Rank #${rank}</div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div>
                                <div class="text-gray-400">MUF Ratio</div>
                                <div class="font-semibold ${band.mufRatio <= 1.0 ? 'text-green-400' : 'text-red-400'}">
                                    ${band.mufRatio.toFixed(2)}x
                                </div>
                            </div>
                            <div>
                                <div class="text-gray-400">Total Score</div>
                                <div class="font-semibold text-white">${band.totalScore}</div>
                            </div>
                        </div>
                        
                        <div class="mt-2 space-y-1 text-xs">
                            <div class="flex justify-between">
                                <span class="text-gray-400">MUF Score:</span>
                                <span class="text-blue-300">${band.mufScore}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Time Score:</span>
                                <span class="text-yellow-300">${band.timeScore}</span>
                                </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Weather Score:</span>
                                <span class="text-purple-300">${band.weatherScore}</span>
                            </div>
                        </div>
                        
                        <div class="mt-2 text-xs">
                            <div class="text-gray-400 mb-1">Strategic Analysis:</div>
                            <div class="text-gray-300">
                                ${band.mufRatio <= 1.0 ? 
                                    `✅ Below MUF - Excellent propagation potential` :
                                    `⚠️ Above MUF - Limited propagation potential`
                                }
                                ${band.timeOptimal ? 
                                    ` | ✅ Optimal for ${dayNight.toLowerCase()}` :
                                    ` | ⚠️ Suboptimal for ${dayNight.toLowerCase()}`
                                }
                                ${band.isSelected ? 
                                    ` | 🎯 SELECTED - High strategic value` : ''
                                }
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            return `
                <div class="space-y-4">
                    <div class="text-center mb-4">
                        <div class="text-lg font-bold text-white mb-2">Band Scoring Analysis</div>
                        <div class="text-sm text-gray-300">
                            Detailed breakdown of how each band was scored and ranked
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                        ${analysisRows}
                    </div>
                    
                    <div class="bg-gray-700 p-3 rounded-lg mt-4">
                        <div class="text-sm text-blue-300 font-semibold mb-2">Scoring Methodology</div>
                        <div class="text-xs text-gray-300 space-y-1">
                            <div><span class="font-semibold">MUF Score (0-45):</span> Based on frequency relationship to current MUF</div>
                            <div><span class="font-semibold">Time Score (0-40):</span> Optimization for current time-of-day</div>
                            <div><span class="font-semibold">Weather Score (0-35):</span> Impact of current weather conditions</div>
                            <div><span class="font-semibold">Total Score:</span> Sum of all factors (0-120)</div>
                            <div class="text-green-400 font-semibold mt-2">Bands with scores ≥ 80 are automatically selected</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function createTimeBasedStrategy(dayNight, muf, solarCycle) {
            const isDay = dayNight === 'Day';
            const highMuf = muf > 20;
            
            let strategy = '';
            
            if (isDay && highMuf) {
                strategy = `
                    <div class="text-sm text-gray-300 mb-2">
                        <strong>Daytime High MUF Strategy:</strong> Focus on 20m, 15m, and 10m bands for global DX contacts.
                        Use higher power and directional antennas for maximum range.
                    </div>
                    <div class="text-xs text-gray-400">
                        • Peak hours: 10:00-16:00 local time<br>
                        • Target regions: Global DX<br>
                        • Power: 200W+ for maximum range
                    </div>
                `;
            } else if (isDay) {
                strategy = `
                    <div class="text-sm text-gray-300 mb-2">
                        <strong>Daytime Moderate MUF Strategy:</strong> Focus on 20m and 40m for continental DX.
                        Use moderate power and optimize antenna setup.
                    </div>
                    <div class="text-xs text-gray-400">
                        • Peak hours: 12:00-15:00 local time<br>
                        • Target regions: Continental DX<br>
                        • Power: 100-150W for efficiency
                    </div>
                `;
            } else if (highMuf) {
                strategy = `
                    <div class="text-sm text-gray-300 mb-2">
                        <strong>Nighttime High MUF Strategy:</strong> Unusual conditions - exploit 20m and 15m for DX.
                        Monitor for sporadic E or other propagation modes.
                    </div>
                    <div class="text-xs text-gray-400">
                        • Peak hours: 20:00-22:00 local time<br>
                        • Target regions: Regional to Continental<br>
                        • Power: 150W+ for DX attempts
                    </div>
                `;
            } else {
                strategy = `
                    <div class="text-sm text-gray-300 mb-2">
                        <strong>Nighttime Low MUF Strategy:</strong> Focus on 80m and 40m for regional contacts.
                        Use lower power and optimize for local/regional range.
                    </div>
                    <div class="text-xs text-gray-400">
                        • Peak hours: 19:00-23:00 local time<br>
                        • Target regions: Local to Regional<br>
                        • Power: 50-100W for efficiency
                    </div>
                `;
            }
            
            return strategy;
        }

        function updateExecutiveSummary(data) {
            const executiveSummaryDiv = document.getElementById('executive-summary');
            if (!executiveSummaryDiv || !data.propagation_summary) return;
            
            const summary = data.propagation_summary;
            const params = summary.propagation_parameters || {};
            const solarCycle = summary.solar_cycle || {};
            
            // Create a coherent executive summary
            const currentTime = summary.current_time || 'Unknown';
            const dayNight = summary.day_night || 'Unknown';
            const muf = params.muf || 'N/A';
            const quality = params.quality || 'Unknown';
            const bestBands = params.best_bands || [];
            const phase = solarCycle.phase || 'Unknown';
            
            safeSetHTML(executiveSummaryDiv, `
                <div class="space-y-4">
                    <!-- Current Status Overview -->
                    <div class="bg-gray-800 p-4 rounded-lg">
                        <div class="text-sm text-gray-400 mb-2">Current Status</div>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="text-gray-400">Time:</span>
                                <span class="ml-2 font-semibold">${currentTime} (${dayNight})</span>
                            </div>
                            <div>
                                <span class="text-gray-400">MUF:</span>
                                <span class="ml-2 font-semibold">${muf} MHz</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Quality:</span>
                                <span class="ml-2 font-semibold ${getPropagationQualityClass(quality)}">${quality}</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Solar Phase:</span>
                                <span class="ml-2 font-semibold">${phase}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Key Findings -->
                    <div class="space-y-2">
                        <div class="text-sm text-gray-400 font-semibold">Key Findings:</div>
                        <div class="text-sm text-gray-300 space-y-1">
                            <div>• MUF is currently ${muf} MHz, indicating ${muf > 20 ? 'excellent' : muf > 15 ? 'good' : muf > 10 ? 'fair' : 'poor'} HF conditions</div>
                            <div>• Solar cycle is in ${phase.toLowerCase()} phase</div>
                            <div>• Best operating bands: ${bestBands.slice(0, 3).join(', ') || 'None identified'}</div>
                            <div>• Overall propagation quality: ${quality}</div>
                        </div>
                    </div>
                    
                    <!-- Outlook -->
                    <div class="space-y-2">
                        <div class="text-sm text-gray-400 font-semibold">Outlook:</div>
                        <div class="text-sm text-gray-300">
                            ${solarCycle.prediction || 'Conditions analysis in progress...'}
                        </div>
                    </div>
                </div>
            `);
        }

                function updateSolarCycleInfo(data) {
            if (!solarCycleDiv || !data.propagation_summary) return;
            
            console.log('Solar cycle data:', data.propagation_summary.solar_cycle);
            const solarCycle = data.propagation_summary.solar_cycle || {};
            
            safeSetHTML(solarCycleDiv, `
                <div class="space-y-4">
                    <!-- Current Status -->
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Phase:</span>
                            <span class="font-semibold">${solarCycle.phase || 'N/A'}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Position:</span>
                            <span class="font-semibold text-blue-300">${solarCycle.cycle_position || 'N/A'}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">SFI:</span>
                            <span class="font-semibold">${solarCycle.sfi_value || 'N/A'}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Sunspots:</span>
                            <span class="font-semibold">${solarCycle.sunspots || 'N/A'}</span>
                        </div>
                    </div>
                    
                    <!-- Trend Analysis -->
                    <div class="space-y-2">
                        <div class="text-sm text-gray-400 font-semibold">Trend Analysis:</div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Direction:</span>
                            <span class="font-semibold ${solarCycle.sfi_trend === 'Strongly Rising' ? 'text-green-400' : solarCycle.sfi_trend === 'Rising' ? 'text-blue-400' : solarCycle.sfi_trend === 'Stable' ? 'text-yellow-400' : 'text-red-400'}">${solarCycle.sfi_trend || 'N/A'}</span>
                        </div>
                        <div class="text-xs text-gray-300">
                            ${solarCycle.trend_description || 'No trend description available'}
                        </div>
                    </div>
                    
                    <!-- Prediction -->
                    <div class="space-y-2">
                        <div class="text-sm text-gray-400 font-semibold">HF Conditions Forecast:</div>
                        <div class="text-sm text-gray-300">
                            ${solarCycle.prediction || 'No prediction available'}
                        </div>
                        <div class="text-xs text-gray-400">
                            ${solarCycle.phase_description || 'No phase description available'}
                        </div>
                    </div>
                    
                    <!-- Calculation Method -->
                    <div class="text-xs text-gray-500 border-t border-gray-700 pt-2">
                        ${solarCycle.calculation_method || 'Calculation method not specified'}
                    </div>
                </div>
            `);
        }

        function updateRiskAssessment(data) {
            const riskAssessmentDiv = document.getElementById('risk-assessment');
            if (!riskAssessmentDiv || !data.propagation_summary) return;
            
            const summary = data.propagation_summary;
            const params = summary.propagation_parameters || {};
            const solarCycle = summary.solar_cycle || {};
            const aurora = summary.aurora_conditions || {};
            
            // Analyze risks based on current conditions
            const risks = [];
            const warnings = [];
            
            // Check geomagnetic activity
            const kIndex = data.solar_conditions?.k_index || 0;
            if (kIndex >= 6) {
                risks.push({
                    level: 'CRITICAL',
                    message: 'Severe geomagnetic storm - Avoid HF operation',
                    impact: 'Complete HF blackout likely',
                    recommendation: 'Use VHF/UHF for local contacts only'
                });
            } else if (kIndex >= 4) {
                risks.push({
                    level: 'HIGH',
                    message: 'Strong geomagnetic activity',
                    impact: 'HF propagation severely degraded',
                    recommendation: 'Focus on lower bands (80m, 40m)'
                });
            } else if (kIndex >= 2) {
                warnings.push({
                    level: 'MODERATE',
                    message: 'Elevated geomagnetic activity',
                    impact: 'HF conditions may be unstable',
                    recommendation: 'Monitor conditions, avoid higher bands'
                });
            }
            
            // Check solar flux
            const sfi = solarCycle.sfi_value || 0;
            if (sfi < 60) {
                risks.push({
                    level: 'HIGH',
                    message: 'Very low solar flux',
                    impact: 'Poor HF conditions across all bands',
                    recommendation: 'Focus on local contacts and lower bands'
                });
            }
            
            // Check aurora conditions
            if (aurora.activity === 'Strong' || aurora.activity === 'Moderate') {
                warnings.push({
                    level: 'MODERATE',
                    message: 'Auroral activity detected',
                    impact: 'HF propagation may be affected at high latitudes',
                    recommendation: 'Monitor conditions, expect unusual propagation'
                });
            }
            
            // If no risks or warnings, show positive status
            if (risks.length === 0 && warnings.length === 0) {
                safeSetHTML(riskAssessmentDiv, `
                    <div class="space-y-3">
                        <div class="bg-green-900/20 border border-green-500/30 p-4 rounded-lg">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-check-circle text-green-400 mr-2"></i>
                                <span class="font-semibold text-green-400">Low Risk Conditions</span>
                            </div>
                            <div class="text-sm text-green-300">
                                Current propagation conditions present minimal risks for HF operation.
                            </div>
                        </div>
                    </div>
                `);
                return;
            }
            
            // Display risks and warnings
            let riskHtml = '';
            
            if (risks.length > 0) {
                riskHtml += `
                    <div class="space-y-3 mb-4">
                        <div class="text-sm text-red-400 font-semibold">High Risk Conditions:</div>
                        ${risks.map(risk => `
                            <div class="bg-red-900/20 border border-red-500/30 p-3 rounded-lg">
                                <div class="flex items-center mb-2">
                                    <i class="fas fa-exclamation-triangle text-red-400 mr-2"></i>
                                    <span class="font-semibold text-red-400">${risk.level}</span>
                                </div>
                                <div class="text-sm text-red-300 mb-2">${risk.message}</div>
                                <div class="text-xs text-red-400 mb-1">Impact: ${risk.impact}</div>
                                <div class="text-xs text-orange-300">Recommendation: ${risk.recommendation}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            if (warnings.length > 0) {
                riskHtml += `
                    <div class="space-y-3">
                        <div class="text-sm text-yellow-400 font-semibold">Warnings:</div>
                        ${warnings.map(warning => `
                            <div class="bg-yellow-900/20 border border-yellow-500/30 p-3 rounded-lg">
                                <div class="flex items-center mb-2">
                                    <i class="fas fa-exclamation-circle text-yellow-400 mr-2"></i>
                                    <span class="font-semibold text-yellow-400">${warning.level}</span>
                                </div>
                                <div class="text-sm text-yellow-300 mb-2">${warning.message}</div>
                                <div class="text-xs text-yellow-400 mb-1">Impact: ${warning.impact}</div>
                                <div class="text-xs text-orange-300">Recommendation: ${warning.recommendation}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            safeSetHTML(riskAssessmentDiv, riskHtml);
        }

        // Main update function
        function updateAllUI(data) {
            console.log('Updating UI with data:', data);
            console.log('Propagation summary structure:', data.propagation_summary);
            
            updateTimestampAndLocation(data);
            updateSolarConditions(data);
            updatePropagationCurrent(data);
            updateBestBandsCurrent(data);
            updateBandConditions(data);
            updateWeatherConditions(data);
            updateExecutiveSummary(data);
            updateSolarCycleInfo(data);
            updateRecommendations(data);
            updateRiskAssessment(data);
            updateLiveActivity(data);
        }

        // Initialize UI when page loads
        document.addEventListener('DOMContentLoaded', function() {
            try {
                const dataElement = document.getElementById('data');
                if (dataElement && dataElement.textContent) {
                    const data = JSON.parse(dataElement.textContent);
                    console.log('Initial data loaded:', data);
                    updateAllUI(data);
                } else {
                    console.warn('No initial data found');
                }
            } catch (error) {
                console.error('Error parsing initial data:', error);
            }
        });

        // Live spots functionality
        function updateLiveActivity(data) {
            if (!summaryDiv || !tableBody) return;
            
            console.log('Live activity data:', data.live_activity);
            
            // Update loading status
            const loadingSpinner = document.getElementById('spots-loading');
            const statusSpan = document.getElementById('spots-status');
            
            if (data.live_activity && data.live_activity.spots && data.live_activity.spots.length > 0) {
                if (loadingSpinner) loadingSpinner.style.display = 'none';
                if (statusSpan) statusSpan.textContent = `${data.live_activity.spots.length} spots loaded`;
            } else {
                if (loadingSpinner) loadingSpinner.style.display = 'inline-block';
                if (statusSpan) statusSpan.textContent = 'Loading spots...';
            }
            
            // Update activity summary
            if (data.live_activity && data.live_activity.summary) {
                const summary = data.live_activity.summary;
                safeSetHTML(summaryDiv, `
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="data-card">
                            <div class="text-gray-400 font-body text-sm mb-2">Total Spots</div>
                            <div class="text-xl font-heading text-white">${summary.total_spots || 0}</div>
                        </div>
                        <div class="data-card">
                            <div class="text-gray-400 font-body text-sm mb-2">Active Bands</div>
                            <div class="text-xl font-heading text-white">${summary.active_bands || 0}</div>
                        </div>
                        <div class="data-card">
                            <div class="text-gray-400 font-body text-sm mb-2">Active Modes</div>
                            <div class="text-xl font-heading text-white">${summary.active_modes || 0}</div>
                        </div>
                        <div class="data-card">
                            <div class="text-gray-400 font-body text-sm mb-2">Active DXCC</div>
                            <div class="text-xl font-heading text-white">${summary.active_dxcc || 0}</div>
                        </div>
                    </div>
                `);
            }
            
            // Update spots table
            if (data.live_activity && data.live_activity.spots && data.live_activity.spots.length > 0) {
                const spots = data.live_activity.spots;
                const spotsHtml = spots.slice(0, 20).map(spot => `
                    <tr class="hover:bg-gray-800">
                        <td class="px-4 py-2 text-sm">${spot.time || spot.timestamp || 'N/A'}</td>
                        <td class="px-4 py-2 font-mono">${spot.callsign || 'N/A'}</td>
                        <td class="px-4 py-2 text-sm">${spot.frequency || 'N/A'}</td>
                        <td class="px-4 py-2 text-sm">${spot.mode || 'N/A'}</td>
                        <td class="px-4 py-2 text-sm">${spot.dxcc || 'N/A'}</td>
                        <td class="px-4 py-2 text-sm">${spot.source || 'N/A'}</td>
                        <td class="px-4 py-2 text-sm text-gray-400">${spot.comment || ''}</td>
                    </tr>
                `).join('');
                
                safeSetHTML(tableBody, spotsHtml);
            } else {
                safeSetHTML(tableBody, `
                    <tr>
                        <td colspan="7" class="px-4 py-2 text-center text-gray-400">
                            No spots data available
                        </td>
                    </tr>
                `);
            }
        }

        // Utility functions
        function checkForUpdates() {
            console.log('Checking for updates...');
            // Implementation for update checking
        }

        function showFullChangelog() {
            console.log('Showing changelog...');
            // Implementation for changelog display
        }

        // Auto-refresh functionality
        let refreshInterval;
        
        function startAutoRefresh() {
            refreshInterval = setInterval(() => {
                // Refresh data every 5 minutes
                console.log('Auto-refreshing data...');
                // Implement data refresh logic here
            }, 5 * 60 * 1000);
        }

        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }

        // Start auto-refresh when page loads
        document.addEventListener('DOMContentLoaded', function() {
            startAutoRefresh();
        });

        // Stop auto-refresh when page is hidden
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                stopAutoRefresh();
            } else {
                startAutoRefresh();
            }
        });
    </script>
</body>
</html>