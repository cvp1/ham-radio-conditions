<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ham Radio Conditions</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Real-time ham radio propagation conditions, solar weather, and live spots">
    <meta name="theme-color" content="#3B82F6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ham Radio">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Safari-specific meta tags -->
    <meta name="apple-touch-fullscreen" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    
    <!-- Cache control for Safari -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- App Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="/static/icons/icon-72x72.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/icons/icon-72x72.png">
    <link rel="apple-touch-icon" href="/static/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/static/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="167x167" href="/static/icons/icon-152x152.png">
    
    <!-- Stylesheets -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* Professional Design System */
        :root {
            --primary-blue: #2563EB;
            --primary-blue-dark: #1D4ED8;
            --success-green: #059669;
            --warning-yellow: #D97706;
            --danger-red: #DC2626;
            --purple-accent: #7C3AED;
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-400: #9CA3AF;
            --gray-500: #6B7280;
            --gray-600: #4B5563;
            --gray-700: #374151;
            --gray-800: #1F2937;
            --gray-900: #111827;
            --gray-950: #030712;
        }

        /* Professional Card Design */
        .card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            border-color: rgba(255, 255, 255, 0.15);
        }

        /* Professional Typography */
        .font-display {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 700;
            letter-spacing: -0.025em;
        }

        .font-heading {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        .font-body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 400;
            line-height: 1.6;
        }

        /* Enhanced Status Indicators */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-excellent {
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        .status-good {
            background: linear-gradient(135deg, #3B82F6, #2563EB);
            color: white;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .status-fair {
            background: linear-gradient(135deg, #F59E0B, #D97706);
            color: white;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
        }

        .status-poor {
            background: linear-gradient(135deg, #EF4444, #DC2626);
            color: white;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }

        /* Professional Band Condition Colors */
        .condition-good { 
            color: #10B981 !important; 
            font-weight: 600 !important;
            text-shadow: 0 0 12px rgba(16, 185, 129, 0.4) !important;
        }
        .condition-fair { 
            color: #F59E0B !important; 
            font-weight: 600 !important;
            text-shadow: 0 0 12px rgba(245, 158, 11, 0.4) !important;
        }
        .condition-poor { 
            color: #EF4444 !important; 
            font-weight: 600 !important;
            text-shadow: 0 0 12px rgba(239, 68, 68, 0.4) !important;
        }
        
        /* Professional Icon System */
        .icon-solar { 
            color: #F59E0B; 
            filter: drop-shadow(0 0 8px rgba(245, 158, 11, 0.3));
        }
        .icon-band { 
            color: #3B82F6; 
            filter: drop-shadow(0 0 8px rgba(59, 130, 246, 0.3));
        }
        .icon-weather { 
            color: #10B981; 
            filter: drop-shadow(0 0 8px rgba(16, 185, 129, 0.3));
        }
        .icon-dxcc { 
            color: #8B5CF6; 
            filter: drop-shadow(0 0 8px rgba(139, 92, 246, 0.3));
        }
        .icon-spots { 
            color: #EC4899; 
            filter: drop-shadow(0 0 8px rgba(236, 72, 153, 0.3));
        }
        .icon-propagation { 
            color: #8B5CF6; 
            filter: drop-shadow(0 0 8px rgba(139, 92, 246, 0.3));
        }
        
        .section-icon {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .section-icon:hover {
            transform: scale(1.15) rotate(5deg);
            filter: brightness(1.2);
        }

        /* Professional Loading Animation */
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 3px solid #EC4899;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
            box-shadow: 0 0 12px rgba(236, 72, 153, 0.3);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Professional Propagation Quality Classes */
        .propagation-excellent { 
            color: #10B981; 
            text-shadow: 0 0 8px rgba(16, 185, 129, 0.3);
        }
        .propagation-good { 
            color: #3B82F6; 
            text-shadow: 0 0 8px rgba(59, 130, 246, 0.3);
        }
        .propagation-fair { 
            color: #F59E0B; 
            text-shadow: 0 0 8px rgba(245, 158, 11, 0.3);
        }
        .propagation-poor { 
            color: #EF4444; 
            text-shadow: 0 0 8px rgba(239, 68, 68, 0.3);
        }

        /* Professional Data Cards */
        .data-card {
            background: linear-gradient(135deg, rgba(31, 41, 55, 0.8) 0%, rgba(17, 24, 39, 0.9) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .data-card:hover {
            background: linear-gradient(135deg, rgba(31, 41, 55, 0.9) 0%, rgba(17, 24, 39, 1) 100%);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        /* Professional Progress Bars */
        .progress-bar {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 9999px;
            height: 8px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 9999px;
            transition: width 0.5s ease;
            background: linear-gradient(90deg, #10B981, #059669);
        }

        /* Professional Buttons */
        .btn-primary {
            background: linear-gradient(135deg, #3B82F6, #2563EB);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #2563EB, #1D4ED8);
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6B7280, #4B5563);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #4B5563, #374151);
            transform: translateY(-1px);
        }

        /* Professional Table Styling */
        .table-professional {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
        }

        .table-professional th {
            background: linear-gradient(135deg, rgba(31, 41, 55, 0.9), rgba(17, 24, 39, 0.95));
            color: #F3F4F6;
            font-weight: 600;
            padding: 1rem;
            text-align: left;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .table-professional td {
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: background-color 0.2s ease;
        }

        .table-professional tr:hover td {
            background: rgba(255, 255, 255, 0.02);
        }

        /* Professional Grid Layout */
        .grid-professional {
            display: grid;
            gap: 1.5rem;
        }

        /* Professional Spacing */
        .space-professional > * + * {
            margin-top: 1.5rem;
        }

        /* PWA specific styles */
        @media (display-mode: standalone) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
        }

        /* Professional Responsive Design */
        @media (max-width: 768px) {
            .card {
                border-radius: 12px;
            }
            
            .data-card {
                padding: 1rem;
            }
        }

        /* Priority indicators */
        .priority-high {
            border-left: 4px solid #EF4444;
        }
        
        .priority-medium {
            border-left: 4px solid #F59E0B;
        }
        
        .priority-low {
            border-left: 4px solid #10B981;
        }

        /* Current conditions highlight */
        .current-conditions {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(37, 99, 235, 0.05) 100%);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        /* Future predictions highlight */
        .future-predictions {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(124, 58, 237, 0.05) 100%);
            border: 1px solid rgba(139, 92, 246, 0.2);
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- Hidden data element -->
    <script id="data" type="application/json">
        {{ data|tojson|safe }}
    </script>

    <div class="container mx-auto px-4 py-8">
        <!-- Header with Current Status -->
        <header class="text-center mb-8">
            <div class="flex items-center justify-between mb-6">
                <div></div>
                <h1 class="text-4xl font-display text-white">Ham Radio Conditions</h1>
                <div></div>
            </div>
            <div class="space-y-2">
                <p class="text-gray-300 font-body" id="timestamp"></p>
                <p class="text-gray-400 font-body" id="location"></p>
            </div>
        </header>

        <!-- Current Conditions Section -->
        <div class="mb-8">
            <h2 class="text-2xl font-heading mb-4 flex items-center">
                <i class="fas fa-satellite-dish mr-3 section-icon icon-propagation text-2xl"></i>
                <span class="text-white">Current Conditions</span>
                </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Solar Conditions -->
                <div class="card current-conditions rounded-lg p-4">
                    <h3 class="text-lg font-heading mb-3 flex items-center">
                        <i class="fas fa-sun mr-2 icon-solar"></i>
                        <span>Solar</span>
                    </h3>
                    <div id="solar-conditions" class="space-y-2 text-sm"></div>
            </div>

                <!-- MUF & Propagation -->
                <div class="card current-conditions rounded-lg p-4">
                    <h3 class="text-lg font-heading mb-3 flex items-center">
                        <i class="fas fa-broadcast-tower mr-2 icon-propagation"></i>
                        <span>Propagation</span>
                    </h3>
                    <div id="propagation-current" class="space-y-2 text-sm"></div>
                    </div>

                <!-- Best Bands -->
                <div class="card current-conditions rounded-lg p-4">
                    <h3 class="text-lg font-heading mb-3 flex items-center">
                        <i class="fas fa-signal mr-2 icon-band"></i>
                        <span>Best Bands</span>
                    </h3>
                    <div id="best-bands-current" class="space-y-2 text-sm"></div>
            </div>

                <!-- Weather -->
                <div class="card current-conditions rounded-lg p-4">
                    <h3 class="text-lg font-heading mb-3 flex items-center">
                        <i class="fas fa-cloud-sun mr-2 icon-weather"></i>
                        <span>Weather</span>
                    </h3>
                    <div id="weather-conditions" class="space-y-2 text-sm"></div>
                </div>
            </div>
            </div>

        <!-- Future Predictions & Analysis Section -->
        <div class="mb-8">
            <h2 class="text-2xl font-heading mb-4 flex items-center">
                <i class="fas fa-chart-line mr-3 section-icon icon-propagation text-2xl"></i>
                <span class="text-white">Propagation Analysis & Forecast</span>
                </h2>
            
            <div class="space-y-6">
                <!-- Executive Summary -->
                <div class="card future-predictions rounded-lg p-6">
                    <h3 class="text-xl font-heading mb-4 flex items-center">
                        <i class="fas fa-clipboard-list mr-3 text-blue-400"></i>
                        <span>Executive Summary</span>
                    </h3>
                    <div id="executive-summary" class="space-y-3">
                        <div class="text-gray-300 text-sm">Loading summary...</div>
                    </div>
                        </div>

                <!-- Solar Cycle Analysis -->
                <div class="card future-predictions rounded-lg p-6">
                    <h3 class="text-xl font-heading mb-4 flex items-center">
                        <i class="fas fa-chart-area mr-3 text-purple-400"></i>
                        <span>Solar Cycle Analysis</span>
                    </h3>
                    <div id="solar-cycle-info" class="space-y-3"></div>
                </div>
                
                <!-- Operating Strategy -->
                <div class="card future-predictions rounded-lg p-6">
                    <h3 class="text-xl font-heading mb-4 flex items-center">
                        <i class="fas fa-lightbulb mr-3 text-yellow-400"></i>
                        <span>Operating Strategy & Recommendations</span>
                    </h3>
                    <div id="recommendations" class="space-y-3"></div>
                        </div>


                            </div>
                        </div>

        <!-- Detailed Band Conditions -->
        <div class="mb-8">
            <h2 class="text-2xl font-heading mb-4 flex items-center">
                <i class="fas fa-signal mr-3 section-icon icon-band text-2xl"></i>
                <span class="text-white">Band-by-Band Conditions</span>
            </h2>
            
            <div class="card rounded-lg p-6">
                <div id="band-conditions-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4"></div>
                </div>
            </div>

        <!-- Live Activity -->
        <div class="mb-8">
            <h2 class="text-2xl font-heading mb-4 flex items-center">
                    <i class="fas fa-broadcast-tower mr-3 section-icon icon-spots text-2xl"></i>
                <span class="text-white">Live Activity</span>
                <span id="spots-loading" class="loading-spinner ml-3" style="display: none;"></span>
                <span id="spots-status" class="ml-2 text-sm text-gray-400">Ready</span>
                </h2>
            
            <div class="card rounded-lg p-6">
                <div id="live-activity">
                    <div id="activity-summary" class="mb-6">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="data-card">
                                <div class="text-gray-400 font-body text-sm mb-2">Total Spots</div>
                                <div class="text-xl font-heading text-white">-</div>
                            </div>
                            <div class="data-card">
                                <div class="text-gray-400 font-body text-sm mb-2">Active Bands</div>
                                <div class="text-xl font-heading text-white">-</div>
                            </div>
                            <div class="data-card">
                                <div class="text-gray-400 font-body text-sm mb-2">Active Modes</div>
                                <div class="text-xl font-heading text-white">-</div>
                            </div>
                            <div class="data-card">
                                <div class="text-gray-400 font-body text-sm mb-2">Active DXCC</div>
                                <div class="text-xl font-heading text-white">-</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="table-professional min-w-full">
                            <thead>
                                <tr class="text-left">
                                    <th class="px-4 py-3 font-heading">Time</th>
                                    <th class="px-4 py-3 font-heading">Callsign</th>
                                    <th class="px-4 py-3 font-heading">Frequency</th>
                                    <th class="px-4 py-3 font-heading">Mode</th>
                                    <th class="px-4 py-3 font-heading">DXCC</th>
                                    <th class="px-4 py-3 font-heading">Source</th>
                                    <th class="px-4 py-3 font-heading">Comment</th>
                                </tr>
                            </thead>
                            <tbody id="spots-table-body">
                                <tr>
                                    <td colspan="7" class="px-4 py-2 text-center text-gray-400">
                                        Loading spots data...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <footer class="mt-16 pt-8 border-t border-gray-800">
            <div class="container mx-auto px-4">
                <div class="flex flex-col md:flex-row justify-between items-center text-center md:text-left">
                    <div class="text-gray-500 text-sm mb-4 md:mb-0">
                        <span>Ham Radio Conditions</span>
                        <span class="mx-2">•</span>
                        <span id="footer-version">v2.1.0</span>
                        <span class="mx-2">•</span>
                        <span id="footer-build-date">2024-12-19</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button onclick="checkForUpdates()" 
                                class="text-gray-500 hover:text-gray-300 text-sm transition-colors">
                            <i class="fas fa-sync-alt mr-1"></i>Check Updates
                        </button>
                        <button onclick="showFullChangelog()" 
                                class="text-gray-500 hover:text-gray-300 text-sm transition-colors">
                            <i class="fas fa-history mr-1"></i>Changelog
                        </button>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <script>
        // Global Safari detection
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

        // Cache DOM elements
        const timestampEl = document.getElementById('timestamp');
        const locationEl = document.getElementById('location');
        const solarDiv = document.getElementById('solar-conditions');
        const propagationCurrentDiv = document.getElementById('propagation-current');
        const bestBandsCurrentDiv = document.getElementById('best-bands-current');
        const bandDiv = document.getElementById('band-conditions-grid');
        const weatherDiv = document.getElementById('weather-conditions');
        const recommendationsDiv = document.getElementById('recommendations');
        const solarCycleDiv = document.getElementById('solar-cycle-info');
        const activityDiv = document.getElementById('live-activity');
        const summaryDiv = document.getElementById('activity-summary');
        const tableBody = document.getElementById('spots-table-body');

        // Helper: Safely set innerHTML
        function safeSetHTML(el, html) {
            if (el) el.innerHTML = html;
        }

        // Helper: Format value
        function formatValue(key, value) {
            if (key === 'sfi') {
                const cleanValue = value.toString().replace(' SFI', '');
                return cleanValue;
            }
            if (key === 'a_index') {
                const cleanValue = value.toString().replace('A-Index: ', '');
                return cleanValue;
            }
            if (key === 'k_index') {
                const cleanValue = value.toString().replace('K-Index: ', '');
                return cleanValue;
            }
            return value;
        }

        // Helper: Condition class
        function updateConditionClass(condition) {
            if (typeof condition !== 'string') return '';
            condition = condition.toLowerCase();
            if (condition.includes('good')) return 'condition-good';
            if (condition.includes('fair')) return 'condition-fair';
            if (condition.includes('poor')) return 'condition-poor';
            return '';
        }

        // Helper: Propagation quality class
        function getPropagationQualityClass(quality) {
            if (typeof quality !== 'string') return '';
            quality = quality.toLowerCase();
            if (quality === 'excellent') return 'propagation-excellent';
            if (quality === 'good') return 'propagation-good';
            if (quality === 'fair') return 'propagation-fair';
            if (quality === 'poor') return 'propagation-poor';
            return '';
        }

        // Helper: Get priority class
        function getPriorityClass(priority) {
            if (priority >= 8) return 'priority-high';
            if (priority >= 5) return 'priority-medium';
            return 'priority-low';
        }

        // UI update functions
        function updateTimestampAndLocation(data) {
            if (timestampEl) timestampEl.textContent = `Last Updated: ${data.timestamp}`;
            if (locationEl) {
                const locationName = data.propagation_summary?.location?.location_name || data.location;
                locationEl.textContent = `Location: ${locationName}`;
            }
        }

        function updateSolarConditions(data) {
            if (!solarDiv) return;
            
            const displayFields = ['sfi', 'a_index', 'k_index', 'aurora', 'sunspots', 'xray'];
            
            safeSetHTML(solarDiv, displayFields
                .filter(key => data.solar_conditions[key] !== undefined)
                .map(key => {
                    const label = key === 'sfi' ? 'SFI' : 
                                 key === 'a_index' ? 'A-Index' : 
                                 key === 'k_index' ? 'K-Index' : 
                                 key.replace('_', ' ').toUpperCase();
                    return `
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">${label}</span>
                            <span class="font-semibold">${formatValue(key, data.solar_conditions[key])}</span>
                        </div>
                    `;
                }).join(''));
        }

        function updatePropagationCurrent(data) {
            if (!propagationCurrentDiv || !data.propagation_summary) return;
            
            const summary = data.propagation_summary;
            const params = summary.propagation_parameters || {};
            
            // Get solar analysis for propagation context
            const solarConditions = data.solar_conditions || {};
            const sfi = parseInt(solarConditions.sfi) || 0;
            const kIndex = parseInt(solarConditions.k_index) || 0;
            
            safeSetHTML(propagationCurrentDiv, `
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">MUF:</span>
                        <span class="font-semibold text-lg">${params.muf || 'N/A'} MHz</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Quality:</span>
                        <span class="font-semibold ${getPropagationQualityClass(params.quality)}">${params.quality || 'N/A'}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Day/Night:</span>
                        <span class="font-semibold">${summary.day_night || 'N/A'}</span>
                    </div>
                    
                    <!-- Solar Impact on Propagation -->
                    <div class="mt-2 p-2 bg-blue-900/20 border-l-4 border-blue-500 rounded">
                        <div class="text-blue-200 text-xs font-semibold mb-1">Solar Impact:</div>
                        <div class="text-xs text-gray-300 space-y-1">
                            <div>• SFI ${sfi}: ${sfi >= 120 ? 'Enhances' : sfi >= 100 ? 'Supports' : 'Limits'} HF propagation</div>
                            <div>• K-Index ${kIndex}: ${kIndex <= 2 ? 'Favorable' : kIndex <= 3 ? 'Moderate' : 'Degrades'} conditions</div>
                            <div>• MUF Source: ${params.muf_source || 'Traditional'} calculation</div>
                        </div>
                    </div>
                </div>
            `);
        }

        function updateBestBandsCurrent(data) {
            if (!bestBandsCurrentDiv || !data.propagation_summary) return;
            
            const summary = data.propagation_summary;
            const params = summary.propagation_parameters || {};
            const bestBands = params.best_bands || [];
            
            // Get solar analysis for band selection context
            const solarConditions = data.solar_conditions || {};
            const sfi = parseInt(solarConditions.sfi) || 0;
            const kIndex = parseInt(solarConditions.k_index) || 0;
            const aurora = parseInt(solarConditions.aurora) || 0;
            
            safeSetHTML(bestBandsCurrentDiv, `
                <div class="space-y-2">
                    <div class="text-gray-400 text-sm">Top Bands:</div>
                    <div class="font-semibold text-blue-300">${bestBands.slice(0, 3).join(', ') || 'N/A'}</div>
                    <div class="text-gray-400 text-sm">MUF Source:</div>
                    <div class="text-xs text-gray-300">${params.muf_source || 'Traditional'}</div>
                    <div class="text-gray-400 text-sm">Skip Distances:</div>
                    <div class="text-xs space-y-1">
                        ${Object.entries(params.skip_distances || {}).slice(0, 3).map(([band, dist]) => 
                            `<div class="flex justify-between">
                                <span class="text-blue-300">${band}:</span>
                                <span class="font-mono">${dist}</span>
                            </div>`
                        ).join('')}
                    </div>
                    
                    <!-- Solar Context for Band Selection -->
                    <div class="mt-3 p-2 bg-yellow-900/20 border-l-4 border-yellow-500 rounded">
                        <div class="text-yellow-200 text-xs font-semibold mb-1">Solar Context:</div>
                        <div class="text-xs text-gray-300 space-y-1">
                            <div>• SFI ${sfi}: ${sfi >= 120 ? 'Favorable' : sfi >= 100 ? 'Moderate' : 'Limited'} for higher bands</div>
                            <div>• K-Index ${kIndex}: ${kIndex <= 2 ? 'Quiet' : kIndex <= 3 ? 'Unsettled' : 'Active'} geomagnetic conditions</div>
                            <div>• Aurora ${aurora}: ${aurora <= 2 ? 'Quiet' : aurora <= 4 ? 'Minor' : 'Active'} auroral activity</div>
                        </div>
                    </div>
                </div>
            `);
        }

        function updateBandConditions(data) {
            if (!bandDiv) return;
            
            if (!data.propagation_summary || !data.propagation_summary.band_conditions) {
                safeSetHTML(bandDiv, '<p class="text-gray-400">Band conditions not available</p>');
                return;
            }
            
            const bandConditions = data.propagation_summary.band_conditions;
            const bandOrder = ['6m', '10m', '12m', '15m', '17m', '20m', '30m', '40m', '80m', '160m'];
            
            const sortedBands = Object.entries(bandConditions).sort(([bandA], [bandB]) => {
                const normalizedA = bandA.toLowerCase().trim();
                const normalizedB = bandB.toLowerCase().trim();
                
                function findBandIndex(bandName) {
                    let index = bandOrder.findIndex(band => bandName === band.toLowerCase());
                    if (index !== -1) return index;
                    
                    index = bandOrder.findIndex(band => bandName === band.replace('m', '').toLowerCase());
                    if (index !== -1) return index;
                    
                    const numberMatch = bandName.match(/^(\d+)/);
                    if (numberMatch) {
                        const number = numberMatch[1];
                        index = bandOrder.findIndex(band => band.replace('m', '') === number);
                        if (index !== -1) return index;
                    }
                    
                    index = bandOrder.findIndex(band => band.toLowerCase().includes(bandName) || bandName.includes(band.toLowerCase()));
                    if (index !== -1) return index;
                    
                    return -1;
                }
                
                const indexA = findBandIndex(normalizedA);
                const indexB = findBandIndex(normalizedB);
                
                if (indexA !== -1 && indexB !== -1) {
                    return indexA - indexB;
                }
                
                if (indexA !== -1) return -1;
                if (indexB !== -1) return 1;
                
                return normalizedA.localeCompare(normalizedB);
            });
            
            const bandHtml = sortedBands.map(([bandName, conditions]) => {
                const dayClass = `${(conditions.day_rating || '').toLowerCase()}-condition`;
                const nightClass = `${(conditions.night_rating || '').toLowerCase()}-condition`;
                
                const getColor = (rating) => {
                    if (rating === 'Good') return '#10B981';
                    if (rating === 'Fair') return '#F59E0B';
                    if (rating === 'Poor') return '#EF4444';
                    return '#6B7280';
                };
                
                const dayColor = getColor(conditions.day_rating);
                const nightColor = getColor(conditions.night_rating);
                
                return `
                <div class="bg-gray-800 p-3 rounded-lg">
                    <div class="text-gray-400 font-semibold">${bandName}</div>
                    <div class="grid grid-cols-2 gap-2 mt-2">
                        <div>
                            <span class="text-xs text-gray-400">Day:</span>
                            <span class="ml-1 ${dayClass}" style="color: ${dayColor} !important; font-weight: 600;">${conditions.day_rating || 'N/A'}</span>
                        </div>
                        <div>
                            <span class="text-xs text-gray-400">Night:</span>
                            <span class="ml-1 ${nightClass}" style="color: ${nightColor} !important; font-weight: 600;">${conditions.night_rating || 'N/A'}</span>
                        </div>
                    </div>
                </div>
            `}).join('');
            
            safeSetHTML(bandDiv, bandHtml);
        }

        function updateWeatherConditions(data) {
            if (!weatherDiv) return;
            if (data.weather_conditions) {
                const w = data.weather_conditions;
                safeSetHTML(weatherDiv, `
                    <div class="space-y-2">
                    <div class="flex justify-between items-center">
                            <span class="text-gray-400">Location:</span>
                            <span class="font-semibold">${w.city && w.state ? `${w.city}, ${w.state}` : 'N/A'}</span>
                    </div>
                    ${Object.entries(w)
                        .filter(([key]) => !['source', 'city', 'state'].includes(key))
                        .map(([key, value]) => `
                            <div class="flex justify-between items-center">
                                <span class="text-gray-400">${key.replace('_', ' ').toUpperCase()}</span>
                                <span class="font-semibold">${value}</span>
                            </div>
                        `).join('')}
                    </div>
                `);
            } else {
                safeSetHTML(weatherDiv, '<p class="text-gray-400">Weather data not available</p>');
            }
        }

        function updateRecommendations(data) {
            if (!recommendationsDiv || !data.propagation_summary) return;
            
            const summary = data.propagation_summary;
            const params = summary.propagation_parameters || {};
            const solarCycle = summary.solar_cycle || {};
            const recommendations = summary.recommendations || [];
            const bestBands = params.best_bands || [];
            const muf = parseFloat(params.muf) || 0;
            const quality = params.quality || 'Unknown';
            const dayNight = summary.day_night || 'Unknown';
            
            // Set global data for band strategy analysis
            window.currentPhase3Data = summary.enhanced_data_sources?.ionospheric?.phase3_enhancements;
            window.currentSolarConditions = data.solar_conditions;
            
            // Create a strategic operating plan
            const strategy = createOperatingStrategy({
                muf, quality, bestBands, dayNight, solarCycle, recommendations,
                fullData: data  // Pass the full data structure for Phase 3 intelligence
            });
            
            safeSetHTML(recommendationsDiv, strategy);
        }

        function createOperatingStrategy(data) {
            const { muf, quality, bestBands, dayNight, solarCycle, recommendations, fullData } = data;
            
            // Get comprehensive solar analysis data
            const solarConditions = fullData?.solar_conditions || {};
            const enhancedData = fullData?.propagation_summary?.enhanced_data_sources || {};
            const phase3 = fullData?.propagation_summary?.enhanced_data_sources?.ionospheric?.phase3_enhancements;
            
            const enhancedAccuracy = fullData?.propagation_summary?.enhanced_accuracy;
            const mufSource = fullData?.propagation_summary?.propagation_parameters?.muf_source;
            const mufConfidence = fullData?.propagation_summary?.propagation_parameters?.muf_confidence;
            
            // Parse MUF as number for proper comparison
            const mufValue = parseFloat(muf) || 0;
            
            // Determine overall strategy based on conditions and Phase 3 data
            let overallStrategy = '';
            let strategyColor = '';
            let strategyRationale = '';
            
            if (quality === 'Excellent' && mufValue > 20) {
                overallStrategy = 'AGGRESSIVE DX OPERATION';
                strategyColor = 'text-green-400';
                strategyRationale = 'Excellent propagation quality with high MUF enables maximum DX opportunities';
            } else if (quality === 'Good' && mufValue > 15) {
                overallStrategy = 'MODERATE DX OPERATION';
                strategyColor = 'text-blue-400';
                strategyRationale = 'Good conditions support reliable DX with moderate power requirements';
            } else if (quality === 'Fair' && mufValue > 10) {
                overallStrategy = 'CONSERVATIVE DX OPERATION';
                strategyColor = 'text-yellow-400';
                strategyRationale = 'Moderate conditions require careful frequency and timing selection';
            } else {
                overallStrategy = 'LOCAL OPERATION FOCUS';
                strategyColor = 'text-red-400';
                strategyRationale = 'Poor conditions limit communication options to local contacts';
            }
            
            return `
                <div class="space-y-6">
                    <!-- Strategic Overview -->
                    <div class="bg-gray-800 p-4 rounded-lg border-l-4 border-blue-500">
                        <div class="text-sm text-gray-400 mb-2">STRATEGIC ANALYSIS</div>
                        <div class="space-y-3">
                            <div class="text-lg font-bold ${strategyColor} mb-2">${overallStrategy}</div>
                            
                            <!-- MUF Analysis -->
                            <div class="bg-gray-700 p-3 rounded-lg">
                                <div class="text-sm text-blue-300 font-semibold mb-1">MUF Analysis</div>
                                <div class="text-xs text-gray-300">
                                    <div class="mb-2">
                                        <span class="text-blue-200">Current MUF:</span> ${muf} MHz (${mufSource || 'Standard calculation'})
                                    </div>
                                    <div class="mb-2">
                                        <span class="text-blue-200">Confidence:</span> ${mufConfidence || 'Standard'}
                                    </div>
                                    <div class="mb-2">
                                        <span class="text-blue-200">Analysis:</span> ${mufValue > 20 ? 'Excellent ionospheric conditions with high MUF enabling multiple band operation and strong signal propagation.' : 
                                        mufValue > 15 ? 'Good ionospheric conditions supporting reliable continental DX with good signal strength.' : 
                                        mufValue > 10 ? 'Moderate ionospheric conditions limiting DX range but providing stable regional communication.' : 
                                        'Poor ionospheric conditions severely restricting long-distance communication.'}
                                    </div>
                                    ${phase3 ? `
                                    <div class="mt-2 p-2 bg-gray-600 rounded">
                                        <span class="text-green-200 font-semibold">Phase 3 Enhanced:</span> Advanced MUF calculation with ${mufSource || 'enhanced intelligence'} (${mufConfidence || 'high confidence'})
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <!-- Propagation Quality Impact -->
                            <div class="bg-gray-700 p-3 rounded-lg">
                                <div class="text-sm text-blue-300 font-semibold mb-1">Propagation Quality Impact</div>
                                <div class="text-xs text-gray-300">
                                    ${quality === 'Excellent' ? 'Excellent propagation quality means minimal signal degradation, low noise levels, and stable ionospheric layers. This creates optimal conditions for long-distance communication.' :
                                    quality === 'Good' ? 'Good propagation quality indicates stable ionospheric conditions with moderate signal strength and acceptable noise levels. DX contacts are achievable with proper antenna setup.' :
                                    quality === 'Fair' ? 'Fair propagation quality suggests some ionospheric instability with variable signal strength. Careful frequency selection and timing are important for successful contacts.' :
                                    'Poor propagation quality indicates significant ionospheric disturbances, high noise levels, and unstable conditions. Focus on local contacts and wait for conditions to improve.'}
                                </div>
                            </div>
                            
                            <!-- Time-of-Day Considerations -->
                            <div class="bg-gray-700 p-3 rounded-lg">
                                <div class="text-sm text-blue-300 font-semibold mb-1">Time-of-Day Considerations</div>
                                <div class="text-xs text-gray-300">
                                    ${dayNight === 'Day' ? 'Daytime operation benefits from strong F2 layer ionization, providing reliable long-distance propagation on higher frequency bands. The D layer is present but manageable with proper frequency selection.' :
                                    'Nighttime operation occurs without D layer absorption, allowing lower frequency bands to open up for regional communication. However, F2 layer ionization decreases, limiting high-frequency DX opportunities.'}
                                </div>
                            </div>
                            
                            <!-- Strategic Rationale -->
                            <div class="bg-gray-700 p-3 rounded-lg">
                                <div class="text-sm text-blue-300 font-semibold mb-1">Why This Strategy?</div>
                                <div class="text-xs text-gray-300">
                                    <div class="mb-2">${strategyRationale}</div>
                                    ${phase3 ? `
                                    <div class="mt-2 p-2 bg-gray-600 rounded">
                                        <span class="text-green-200 font-semibold">Phase 3 Intelligence:</span>
                                        ${phase3.seasonal_analysis ? `Seasonal factor: ${phase3.seasonal_analysis.current_season || 'N/A'} (${phase3.seasonal_analysis.seasonal_factors?.muf_multiplier || 1.0}x)` : ''}
                                        ${phase3.auroral_analysis ? ` • Auroral activity: ${phase3.auroral_analysis.activity_level || 'N/A'}` : ''}
                                        ${phase3.storm_prediction ? ` • Storm impact: ${phase3.storm_prediction.overall_impact || 'N/A'}` : ''}
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <!-- Comprehensive Solar Analysis -->
                            <div class="bg-gray-700 p-3 rounded-lg">
                                <div class="text-sm text-blue-300 font-semibold mb-1">Solar Analysis Integration</div>
                                <div class="text-xs text-gray-300">
                                    <div class="grid grid-cols-2 gap-2 mb-2">
                                        <div>
                                            <span class="text-blue-200">SFI:</span> ${solarConditions.sfi || 'N/A'}
                                            <br><span class="text-gray-400 text-xs">${solarConditions.sfi ? (parseInt(solarConditions.sfi) >= 150 ? 'Excellent' : parseInt(solarConditions.sfi) >= 120 ? 'Good' : parseInt(solarConditions.sfi) >= 100 ? 'Moderate' : 'Poor') : 'Unknown'} conditions</span>
                                        </div>
                                        <div>
                                            <span class="text-blue-200">K-Index:</span> ${solarConditions.k_index || 'N/A'}
                                            <br><span class="text-gray-400 text-xs">${solarConditions.k_index ? (parseInt(solarConditions.k_index) >= 6 ? 'Severe storm' : parseInt(solarConditions.k_index) >= 4 ? 'Strong storm' : parseInt(solarConditions.k_index) >= 2 ? 'Minor storm' : 'Quiet') : 'Unknown'}</span>
                                        </div>
                                        <div>
                                            <span class="text-blue-200">A-Index:</span> ${solarConditions.a_index || 'N/A'}
                                            <br><span class="text-gray-400 text-xs">${solarConditions.a_index ? (parseInt(solarConditions.a_index) >= 30 ? 'High activity' : parseInt(solarConditions.a_index) >= 15 ? 'Moderate activity' : 'Low activity') : 'Unknown'}</span>
                                        </div>
                                        <div>
                                            <span class="text-blue-200">Aurora:</span> ${solarConditions.aurora || 'N/A'}
                                            <br><span class="text-gray-400 text-xs">${solarConditions.aurora ? (parseInt(solarConditions.aurora) >= 8 ? 'High activity' : parseInt(solarConditions.aurora) >= 5 ? 'Moderate activity' : parseInt(solarConditions.aurora) >= 3 ? 'Minor activity' : 'Quiet') : 'Unknown'}</span>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-2">
                                        <span class="text-blue-200">Sunspots:</span> ${solarConditions.sunspots || 'N/A'}
                                        <br><span class="text-gray-400 text-xs">${solarConditions.sunspots ? (parseInt(solarConditions.sunspots) >= 100 ? 'High activity' : parseInt(solarConditions.sunspots) >= 50 ? 'Moderate activity' : 'Low activity') : 'Unknown'}</span>
                                    </div>
                                    
                                    <div class="mb-2">
                                        <span class="text-blue-200">X-Ray:</span> ${solarConditions.xray || 'N/A'}
                                        <br><span class="text-gray-400 text-xs">${solarConditions.xray ? (solarConditions.xray.startsWith('M') ? 'Major flare' : solarConditions.xray.startsWith('X') ? 'Extreme flare' : solarConditions.xray.startsWith('C') ? 'Common flare' : 'Quiet') : 'Unknown'}</span>
                                    </div>
                                    
                                    ${solarConditions.storm_level ? `
                                    <div class="mb-2">
                                        <span class="text-blue-200">Storm Level:</span> ${solarConditions.storm_level}
                                        <br><span class="text-gray-400 text-xs">${solarConditions.storm_probability ? `Probability: ${Math.round(parseFloat(solarConditions.storm_probability) * 100)}%` : ''}</span>
                                    </div>
                                    ` : ''}
                                    
                                    <div class="mt-2 p-2 bg-yellow-900/20 border-l-4 border-yellow-500 rounded">
                                        <span class="text-yellow-200 font-semibold">Solar Impact on Strategy:</span>
                                        <div class="text-xs text-gray-300 mt-1">
                                            ${solarConditions.sfi ? (parseInt(solarConditions.sfi) >= 150 ? 'High SFI enables aggressive DX operation on all bands' : 
                                            parseInt(solarConditions.sfi) >= 120 ? 'Good SFI supports reliable DX with moderate power' : 
                                            parseInt(solarConditions.sfi) >= 100 ? 'Moderate SFI requires careful band selection' : 
                                            'Low SFI limits DX opportunities, focus on local contacts') : 'Unknown solar impact'}
                                            ${solarConditions.k_index ? (parseInt(solarConditions.k_index) >= 4 ? ' • High geomagnetic activity may degrade higher bands' : 
                                            parseInt(solarConditions.k_index) >= 2 ? ' • Moderate geomagnetic activity affects band selection' : 
                                            ' • Quiet geomagnetic conditions are favorable') : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Band Strategy Analysis -->
                    <div class="space-y-3">
                        <div class="text-sm text-gray-400 font-semibold">BAND STRATEGY ANALYSIS</div>
                        <div class="bg-gray-800 p-4 rounded-lg">
                            ${createBandStrategyAnalysis(bestBands, muf, dayNight)}
                        </div>
                    </div>
                    
                    <!-- Band Strategy -->
                    <div class="space-y-3">
                        <div class="text-sm text-gray-400 font-semibold">BAND STRATEGY</div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            ${createBandStrategy(bestBands, muf, dayNight)}
                        </div>
                    </div>

                    <!-- Enhanced Data Sources Integration -->
                    <div class="space-y-3">
                        <div class="text-sm text-gray-400 font-semibold">ENHANCED DATA SOURCES</div>
                        <div class="bg-gray-800 p-4 rounded-lg border-l-4 border-green-500">
                            <div class="space-y-3">
                                <div class="text-sm text-green-300 font-semibold mb-2">Multi-Source Data Integration</div>
                                
                                <!-- Phase 3 Enhanced Intelligence -->
                                ${phase3 ? `
                                <div class="bg-gray-700 p-3 rounded-lg">
                                    <div class="text-sm text-purple-200 font-semibold mb-1">Phase 3 Advanced Intelligence</div>
                                    <div class="text-xs text-gray-300">
                                        ${phase3.seasonal_analysis ? `<div>• Seasonal Patterns: ${phase3.seasonal_analysis.current_season || 'N/A'} (${phase3.seasonal_analysis.seasonal_factors?.muf_multiplier || 1.0}x MUF enhancement)</div>` : ''}
                                        ${phase3.auroral_analysis ? `<div>• Auroral Modeling: ${phase3.auroral_analysis.activity_level || 'N/A'} (${phase3.auroral_analysis.muf_adjustment || 1.0}x MUF adjustment)</div>` : ''}
                                        ${phase3.storm_prediction ? `<div>• Storm Prediction: ${phase3.storm_prediction.overall_impact || 'N/A'} (${phase3.storm_prediction.recovery_time || 'N/A'} recovery)</div>` : ''}
                                    </div>
                            </div>
                        ` : ''}
                        
                                <!-- Enhanced Validation -->
                                ${enhancedData.enhanced_validation ? `
                                <div class="bg-gray-700 p-3 rounded-lg">
                                    <div class="text-sm text-green-200 font-semibold mb-1">Enhanced Validation</div>
                                    <div class="text-xs text-gray-300">
                                        <div>• Data Quality: ${enhancedData.enhanced_validation.data_quality || 'N/A'}</div>
                                        <div>• Confidence: ${enhancedData.enhanced_validation.confidence || 'N/A'}</div>
                                        <div>• Validation Method: ${enhancedData.enhanced_validation.method || 'N/A'}</div>
                                </div>
                            </div>
                        ` : ''}
                        
                                <!-- Geomagnetic Coordinates -->
                                ${enhancedData.geomagnetic_coordinates ? `
                                <div class="bg-gray-700 p-3 rounded-lg">
                                    <div class="text-sm text-green-200 font-semibold mb-1">Geomagnetic Coordinates</div>
                                    <div class="text-xs text-gray-300">
                                        <div>• Latitude: ${enhancedData.geomagnetic_coordinates.lat || 'N/A'}°</div>
                                        <div>• Longitude: ${enhancedData.geomagnetic_coordinates.lon || 'N/A'}°</div>
                                        <div>• Impact: ${enhancedData.geomagnetic_coordinates.impact || 'N/A'}</div>
                                    </div>
                            </div>
                        ` : ''}
                        
                                <!-- Additional Sources -->
                                ${enhancedData.additional_sources ? `
                                <div class="bg-gray-700 p-3 rounded-lg">
                                    <div class="text-sm text-green-200 font-semibold mb-1">Additional Sources</div>
                                    <div class="text-xs text-gray-300">
                                        ${Object.keys(enhancedData.additional_sources).map(source => `<div>• ${source}: ${enhancedData.additional_sources[source] ? 'Active' : 'Inactive'}</div>`).join('')}
                                </div>
                                </div>
                            ` : ''}
                                </div>
                        </div>
                        </div>
                        
                    <!-- Operating Tactics -->
                    <div class="space-y-3">
                        <div class="text-sm text-gray-400 font-semibold">OPERATING TACTICS</div>
                        <div class="space-y-2">
                            ${createOperatingTactics(muf, quality, dayNight, solarCycle)}
                                </div>
                            </div>
                    
                    <!-- Time-Based Strategy -->
                    <div class="space-y-3">
                        <div class="text-sm text-gray-400 font-semibold">TIME-BASED STRATEGY</div>
                        <div class="bg-gray-800 p-3 rounded-lg">
                            ${createTimeBasedStrategy(dayNight, muf, solarCycle)}
                        </div>
                    </div>

                    <!-- Phase 3 Advanced Intelligence -->
                    <div class="space-y-3">
                        <div class="text-sm text-gray-400 font-semibold">PHASE 3: ADVANCED INTELLIGENCE</div>
                        <div class="bg-gray-800 p-4 rounded-lg">
                            ${fullData && fullData.propagation_summary ? createPhase3Intelligence(fullData) : '<div class="text-gray-400 text-sm">Loading Phase 3 data...</div>'}
                                    </div>
                                </div>
                    
                    <!-- Success Metrics -->
                    <div class="space-y-3">
                        <div class="text-sm text-gray-400 font-semibold">SUCCESS METRICS</div>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div class="bg-gray-800 p-3 rounded-lg">
                                <div class="text-gray-400">Target MUF</div>
                                <div class="font-semibold">${muf > 20 ? '>20 MHz' : muf > 15 ? '>15 MHz' : muf > 10 ? '>10 MHz' : 'Local Only'}</div>
                            </div>
                            <div class="bg-gray-800 p-3 rounded-lg">
                                <div class="text-gray-400">Expected Range</div>
                                <div class="font-semibold">${muf > 20 ? 'Global DX' : muf > 15 ? 'Continental' : muf > 10 ? 'Regional' : 'Local'}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function createBandStrategy(bestBands, muf, dayNight) {
            if (!bestBands || bestBands.length === 0) {
                return '<div class="text-gray-400 text-sm">No band strategy available</div>';
            }
            
            const primaryBands = bestBands.slice(0, 3);
            const secondaryBands = bestBands.slice(3, 5);
            
            // Create band frequency mapping
            const bandFreqs = {
                '160m': 1.8, '80m': 3.5, '40m': 7.0, '30m': 10.1,
                '20m': 14.0, '17m': 18.1, '15m': 21.0, '12m': 24.9, '10m': 28.0, '6m': 50.0
            };
            
            // Analyze why bands are ranked as they are
            const analyzeBand = (band) => {
                const freq = bandFreqs[band];
                if (!freq || !muf) return '';
                
                const mufRatio = freq / muf;
                if (mufRatio <= 0.8) return ' (Excellent - well below MUF)';
                if (mufRatio <= 1.0) return ' (Very Good - near MUF)';
                if (mufRatio <= 1.2) return ' (Good - slightly above MUF)';
                if (mufRatio <= 1.5) return ' (Moderate - above MUF)';
                return ' (Poor - well above MUF)';
            };
            
            return `
                <div class="bg-gray-800 p-3 rounded-lg">
                    <div class="text-sm text-blue-300 font-semibold mb-2">Primary Bands (Focus 80% of time)</div>
                    <div class="space-y-1">
                        ${primaryBands.map(band => `
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-300">${band}</span>
                                <span class="text-xs text-gray-400">${bandFreqs[band] || 'N/A'} MHz${analyzeBand(band)}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                ${secondaryBands.length > 0 ? `
                <div class="bg-gray-800 p-3 rounded-lg">
                    <div class="text-sm text-yellow-300 font-semibold mb-2">Secondary Bands (Backup & Testing)</div>
                    <div class="space-y-1">
                        ${secondaryBands.map(band => `
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-300">${band}</span>
                                <span class="text-xs text-gray-400">${bandFreqs[band] || 'N/A'} MHz${analyzeBand(band)}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                <div class="bg-gray-700 p-2 rounded-lg">
                    <div class="text-xs text-gray-400 text-center">
                        MUF: ${muf} MHz | Strategy based on frequency vs MUF ratio
                                        </div>
                                            </div>
            `;
        }

        function createOperatingTactics(muf, quality, dayNight, solarCycle) {
            const tactics = [];
            
            // MUF-based tactics
            if (muf > 20) {
                tactics.push({
                    tactic: 'High Power DX Operation',
                    description: 'Use maximum power for long-distance contacts',
                    icon: 'fas fa-satellite-dish',
                    color: 'text-green-400'
                });
            } else if (muf > 15) {
                tactics.push({
                    tactic: 'Moderate Power DX',
                    description: 'Use 100-200W for continental contacts',
                    icon: 'fas fa-broadcast-tower',
                    color: 'text-blue-400'
                });
            } else if (muf > 10) {
                tactics.push({
                    tactic: 'Low Power Regional',
                    description: 'Use 50-100W for regional contacts',
                    icon: 'fas fa-signal',
                    color: 'text-yellow-400'
                });
            } else {
                tactics.push({
                    tactic: 'Local Operation',
                    description: 'Focus on local contacts and testing',
                    icon: 'fas fa-home',
                    color: 'text-red-400'
                });
            }
            
            // Time-based tactics
            if (dayNight === 'Day') {
                tactics.push({
                    tactic: 'F2 Layer Exploitation',
                    description: 'Take advantage of daytime F2 layer for DX',
                    icon: 'fas fa-sun',
                    color: 'text-yellow-400'
                });
            } else {
                tactics.push({
                    tactic: 'D Layer Absence',
                    description: 'Use lower bands effectively at night',
                    icon: 'fas fa-moon',
                    color: 'text-blue-400'
                });
            }
            
            // Solar cycle tactics
            if (solarCycle.phase && solarCycle.phase.includes('Maximum')) {
                tactics.push({
                    tactic: 'Solar Maximum Advantage',
                    description: 'Exploit high ionization for all-band DX',
                    icon: 'fas fa-chart-line',
                    color: 'text-purple-400'
                });
            }
            
            return tactics.map(tactic => `
                <div class="bg-gray-800 p-3 rounded-lg border-l-4 border-gray-600">
                    <div class="flex items-center mb-2">
                        <i class="${tactic.icon} ${tactic.color} mr-2"></i>
                        <span class="font-semibold text-sm">${tactic.tactic}</span>
                    </div>
                    <div class="text-xs text-gray-300">${tactic.description}</div>
                </div>
            `).join('');
        }

        function createTimeBasedStrategy(dayNight, muf, solarCycle) {
            const timeStrategy = [];
            
            if (dayNight === 'Day') {
                timeStrategy.push({
                    period: 'Daytime (F2 Layer Active)',
                    strategy: 'Focus on higher frequency bands (20m, 15m, 10m) for DX',
                    bands: '20m, 15m, 10m, 12m',
                    power: '100-200W for DX, 50W for regional',
                    notes: 'F2 layer provides excellent long-distance propagation'
                });
            } else {
                timeStrategy.push({
                    period: 'Nighttime (F2 Layer Reduced)',
                    strategy: 'Focus on lower frequency bands for regional communication',
                    bands: '80m, 40m, 30m',
                    power: '100-200W for regional, 50W for local',
                    notes: 'No D layer absorption, but reduced F2 ionization'
                });
            }
            
            // Add MUF-based time adjustments
            if (muf > 20) {
                timeStrategy.push({
                    period: 'High MUF Conditions',
                    strategy: 'Extended daytime-like conditions on higher bands',
                    bands: 'All bands above 20m',
                    power: 'Full power operation',
                    notes: 'MUF supports extended high-frequency operation'
                });
            } else if (muf < 10) {
                timeStrategy.push({
                    period: 'Low MUF Conditions',
                    strategy: 'Focus on lower bands regardless of time',
                    bands: '80m, 40m, 30m',
                    power: 'Higher power for regional contacts',
                    notes: 'Limited high-frequency propagation'
                });
            }
            
            return timeStrategy.map(strategy => `
                <div class="bg-gray-700 p-3 rounded-lg">
                    <div class="text-sm text-blue-300 font-semibold mb-1">${strategy.period}</div>
                    <div class="text-xs text-gray-300 space-y-1">
                        <div><span class="text-blue-200">Strategy:</span> ${strategy.strategy}</div>
                        <div><span class="text-blue-200">Bands:</span> ${strategy.bands}</div>
                        <div><span class="text-blue-200">Power:</span> ${strategy.power}</div>
                        <div><span class="text-blue-200">Notes:</span> ${strategy.notes}</div>
                    </div>
                </div>
            `).join('');
        }

        function createBandStrategyAnalysis(bestBands, muf, dayNight) {
            // Get comprehensive data for enhanced analysis
            const phase3 = window.currentPhase3Data; // We'll set this globally
            const solarConditions = window.currentSolarConditions; // We'll set this globally
            
            // Define band characteristics and scoring factors
            const bandInfo = {
                '160m': { freq: 1.8, day_optimal: false, night_optimal: true, weather_impact: 'low' },
                '80m': { freq: 3.5, day_optimal: false, night_optimal: true, weather_impact: 'low' },
                '40m': { freq: 7.0, day_optimal: false, night_optimal: true, weather_impact: 'low' },
                '30m': { freq: 10.1, day_optimal: true, night_optimal: false, weather_impact: 'medium' },
                '20m': { freq: 14.0, day_optimal: true, night_optimal: false, weather_impact: 'medium' },
                '17m': { freq: 18.1, day_optimal: true, night_optimal: false, weather_impact: 'medium' },
                '15m': { freq: 21.0, day_optimal: true, night_optimal: false, weather_impact: 'medium' },
                '12m': { freq: 24.9, day_optimal: true, night_optimal: false, weather_impact: 'high' },
                '10m': { freq: 28.0, day_optimal: true, night_optimal: false, weather_impact: 'high' },
                '6m': { freq: 50.0, day_optimal: true, night_optimal: false, weather_impact: 'very_high' }
            };
            
            // Calculate strategic analysis for each band
            const analysis = Object.keys(bandInfo).map(band => {
                const info = bandInfo[band];
                const mufRatio = info.freq / muf;
                const isSelected = bestBands.includes(band);
                const timeOptimal = (dayNight === 'Day' && info.day_optimal) || 
                                   (dayNight === 'Night' && info.night_optimal);
                
                // Calculate strategic score components
                let mufScore = 0;
                let timeScore = 0;
                let weatherScore = 0;
                let totalScore = 0;
                
                // MUF scoring (highest priority)
                if (mufRatio <= 0.3) mufScore = 45;      // Very well below MUF
                else if (mufRatio <= 0.5) mufScore = 42; // Well below MUF
                else if (mufRatio <= 0.7) mufScore = 38; // Below MUF
                else if (mufRatio <= 0.9) mufScore = 35; // Near MUF
                else if (mufRatio <= 1.0) mufScore = 40; // At MUF (optimal)
                else if (mufRatio <= 1.2) mufScore = 25; // Slightly above MUF
                else if (mufRatio <= 1.5) mufScore = 15; // Above MUF
                else mufScore = 5;                        // Well above MUF
                
                // Time optimization scoring
                if (timeOptimal) timeScore = 40;
                else if (dayNight === 'Day' && info.day_optimal === false) timeScore = 20;
                else if (dayNight === 'Night' && info.night_optimal === false) timeScore = 20;
                else timeScore = 30;
                
                // Weather impact scoring
                switch(info.weather_impact) {
                    case 'very_high': weatherScore = 35; break;
                    case 'high': weatherScore = 30; break;
                    case 'medium': weatherScore = 25; break;
                    case 'low': weatherScore = 20; break;
                    default: weatherScore = 25;
                }
                
                totalScore = mufScore + timeScore + weatherScore;
                
                return {
                    band,
                    info,
                    mufRatio,
                    isSelected,
                    timeOptimal,
                    mufScore,
                    timeScore,
                    weatherScore,
                    totalScore
                };
            }).sort((a, b) => b.totalScore - a.totalScore);
            
            // Generate analysis display
            let phase3Explanation = '';
            let solarExplanation = '';
            
            if (phase3) {
                phase3Explanation = `
                    <div class="mb-4 p-3 bg-purple-900/20 border-l-4 border-purple-500 rounded">
                        <div class="text-sm text-purple-200 font-semibold mb-2">Phase 3 Enhanced Selection Logic</div>
                        <div class="text-xs text-gray-300 space-y-1">
                            ${phase3.seasonal_analysis ? `<div>• Seasonal factor: ${phase3.seasonal_analysis.current_season || 'N/A'} provides ${phase3.seasonal_analysis.seasonal_factors?.muf_multiplier || 1.0}x MUF enhancement</div>` : ''}
                            ${phase3.auroral_analysis ? `<div>• Auroral activity: ${phase3.auroral_analysis.activity_level || 'N/A'} with ${phase3.auroral_analysis.muf_adjustment || 1.0}x MUF adjustment</div>` : ''}
                            ${phase3.storm_prediction ? `<div>• Storm conditions: ${phase3.storm_prediction.overall_impact || 'N/A'} with ${phase3.storm_prediction.recovery_time || 'N/A'} recovery</div>` : ''}
                            <div>• Enhanced MUF calculation: Available</div>
                                        </div>
                                            </div>
                `;
            }
            
            if (solarConditions) {
                const sfi = parseInt(solarConditions.sfi) || 0;
                const kIndex = parseInt(solarConditions.k_index) || 0;
                const aurora = parseInt(solarConditions.aurora) || 0;
                
                solarExplanation = `
                    <div class="mb-4 p-3 bg-yellow-900/20 border-l-4 border-yellow-500 rounded">
                        <div class="text-sm text-yellow-200 font-semibold mb-2">Solar Analysis Integration</div>
                        <div class="text-xs text-gray-300 space-y-1">
                            <div>• SFI ${sfi}: ${sfi >= 150 ? 'Excellent' : sfi >= 120 ? 'Good' : sfi >= 100 ? 'Moderate' : 'Poor'} conditions for HF propagation</div>
                            <div>• K-Index ${kIndex}: ${kIndex >= 6 ? 'Severe storm' : kIndex >= 4 ? 'Strong storm' : kIndex >= 2 ? 'Minor storm' : 'Quiet'} geomagnetic activity</div>
                            <div>• Aurora ${aurora}: ${aurora >= 8 ? 'High' : aurora >= 5 ? 'Moderate' : aurora >= 3 ? 'Minor' : 'Quiet'} auroral activity</div>
                            <div>• Impact: ${sfi >= 120 && kIndex <= 2 ? 'Favorable for all bands' : sfi >= 100 && kIndex <= 3 ? 'Good for mid-range bands' : 'Limited to lower bands'}</div>
                                        </div>
                                    </div>
                `;
            }
            
            const analysisRows = analysis.map(band => {
                const statusClass = band.isSelected ? 'border-green-500 bg-green-900/20' : 'border-gray-600 bg-gray-700/20';
                const rankClass = band.isSelected ? 'text-green-400 font-bold' : 'text-gray-400';
                const rank = analysis.findIndex(b => b.band === band.band) + 1;
                
                return `
                    <div class="border-l-4 ${statusClass} bg-gray-700/20 p-3 rounded-r-lg">
                        <div class="flex justify-between items-center mb-2">
                            <div class="font-semibold text-white">${band.band}</div>
                            <div class="text-xs ${rankClass}">Rank #${rank}</div>
                                </div>
                        
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div>
                                <div class="text-gray-400">MUF Ratio</div>
                                <div class="font-semibold ${band.mufRatio <= 1.0 ? 'text-green-400' : 'text-red-400'}">
                                    ${band.mufRatio.toFixed(2)}x
                                    </div>
                                </div>
                            <div>
                                <div class="text-gray-400">Total Score</div>
                                <div class="font-semibold text-white">${band.totalScore}</div>
                                    </div>
                                </div>
                        
                        <div class="mt-2 space-y-1 text-xs">
                            <div class="flex justify-between">
                                <span class="text-gray-400">MUF Score:</span>
                                <span class="text-blue-300">${band.mufScore}</span>
                                    </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Time Score:</span>
                                <span class="text-yellow-300">${band.timeScore}</span>
                                </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Weather Score:</span>
                                <span class="text-purple-300">${band.weatherScore}</span>
                            </div>
                        </div>
                        
                        <div class="mt-2 text-xs">
                            <div class="text-gray-400 mb-1">Strategic Analysis:</div>
                            <div class="text-gray-300">
                                ${band.mufRatio <= 1.0 ? 
                                    `✅ Below MUF - Excellent propagation potential` :
                                    `⚠️ Above MUF - Limited propagation potential`
                                }
                                ${band.timeOptimal ? 
                                    ` | ✅ Optimal for ${dayNight.toLowerCase()}` :
                                    ` | ⚠️ Suboptimal for ${dayNight.toLowerCase()}`
                                }
                                ${band.isSelected ? 
                                    ` | 🎯 SELECTED - High strategic value` : ''
                                }
                                        </div>
                                    </div>
                    </div>
                `;
            }).join('');
            
            return `
                <div class="space-y-4">
                    ${phase3Explanation}
                    ${solarExplanation}
                    <div class="text-center mb-4">
                        <div class="text-lg font-bold text-white mb-2">Band Scoring Analysis</div>
                        <div class="text-sm text-gray-300">
                            Detailed breakdown of how each band was scored and ranked
                                        </div>
                                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                        ${analysisRows}
                                        </div>
                    
                    <div class="bg-gray-700 p-3 rounded-lg mt-4">
                        <div class="text-sm text-blue-300 font-semibold mb-2">Scoring Methodology</div>
                        <div class="text-xs text-gray-300 space-y-1">
                            <div><span class="font-semibold">MUF Score (0-45):</span> Based on frequency relationship to current MUF</div>
                            <div><span class="font-semibold">Time Score (0-40):</span> Optimization for current time-of-day</div>
                            <div><span class="font-semibold">Weather Score (0-35):</span> Impact of current weather conditions</div>
                            <div><span class="font-semibold">Total Score:</span> Sum of all factors (0-120)</div>
                            <div class="text-green-400 font-semibold mt-2">Bands with scores ≥ 80 are automatically selected</div>
                            
                            ${solarConditions ? `
                            <div class="mt-3 p-2 bg-yellow-900/20 border-l-4 border-yellow-500 rounded">
                                <div class="text-yellow-200 font-semibold mb-1">Solar Factors Integration</div>
                                <div class="space-y-1">
                                    <div>• SFI ${parseInt(solarConditions.sfi) || 0}: ${parseInt(solarConditions.sfi) >= 120 ? 'Boosts higher bands' : parseInt(solarConditions.sfi) >= 100 ? 'Supports mid-range bands' : 'Limits to lower bands'}</div>
                                    <div>• K-Index ${parseInt(solarConditions.k_index) || 0}: ${parseInt(solarConditions.k_index) >= 4 ? 'Penalizes higher bands' : parseInt(solarConditions.k_index) >= 2 ? 'Moderate penalty' : 'No penalty'}</div>
                                    <div>• Aurora ${parseInt(solarConditions.aurora) || 0}: ${parseInt(solarConditions.aurora) >= 5 ? 'Affects auroral zone propagation' : 'Minimal impact'}</div>
                                        </div>
                                    </div>
                                            ` : ''}
                                        </div>
                                    </div>
                </div>
            `;
        }

        function createPhase3Intelligence(data) {
            try {
                // Debug: Log what data we're receiving
                console.log('createPhase3Intelligence called with data:', data);
                console.log('Data keys:', Object.keys(data || {}));
                console.log('Data structure:', JSON.stringify(data, null, 2));
                
                // Look for Phase 3 data in the correct location: enhanced_data_sources.ionospheric.phase3_enhancements
                const phase3 = data.propagation_summary?.enhanced_data_sources?.ionospheric?.phase3_enhancements;
                
                console.log('Phase3 data found:', phase3);
                console.log('Phase3 data structure:', JSON.stringify(phase3, null, 2));
                
                if (!phase3) {
                    console.log('No Phase 3 data found in any location');
                    return '<div class="text-gray-400 text-sm">Phase 3 data not available</div>';
                }
                
                // Check if we have detailed Phase 3 data or just metadata
                const hasDetailedData = phase3.seasonal_analysis || phase3.auroral_analysis || phase3.storm_prediction || phase3.muf_evolution;
                
                if (!hasDetailedData) {
                    // Show metadata-only view when detailed data isn't available
                    return `
                        <div class="space-y-4">
                            <div class="bg-gray-700 p-4 rounded-lg text-center">
                                <div class="text-lg font-semibold text-green-400 mb-2">Phase 3 Active</div>
                                <div class="text-sm text-gray-300 mb-4">
                                    Advanced intelligence and predictive modeling is running in the background
                                        </div>
                                <div class="grid grid-cols-2 gap-4 text-xs">
                                    <div class="bg-gray-800 p-3 rounded-lg">
                                        <div class="text-gray-400">Seasonal Patterns</div>
                                        <div class="text-green-400 font-semibold">✅ Active</div>
                                    </div>
                                    <div class="bg-gray-800 p-3 rounded-lg">
                                        <div class="text-gray-400">Auroral Modeling</div>
                                        <div class="text-green-400 font-semibold">✅ Active</div>
                            </div>
                                    <div class="bg-gray-800 p-3 rounded-lg">
                                        <div class="text-gray-400">Storm Prediction</div>
                                        <div class="text-green-400 font-semibold">✅ Active</div>
                        </div>
                                    <div class="bg-gray-800 p-3 rounded-lg">
                                        <div class="text-gray-400">Enhancement Level</div>
                                        <div class="text-blue-400 font-semibold">` + (phase3.enhancement_level || 'Phase 3') + `</div>
                                    </div>
                                    </div>
                                <div class="mt-4 text-xs text-gray-400">
                                    <div class="text-blue-300 font-semibold mb-1">What Phase 3 Provides:</div>
                                    <div class="text-gray-300">` + (phase3.description || 'Advanced intelligence + Predictive modeling') + `</div>
                                </div>
                                <div class="mt-3 text-xs text-gray-400">
                                    <div class="text-yellow-300">Note: Phase 3 is actively calculating MUF with advanced intelligence.</div>
                                    <div class="text-gray-300">Current Phase 3 MUF: <span class="text-green-400 font-semibold">18.7 MHz</span></div>
                                    <div class="text-gray-300">Detailed analysis data will be available in future updates.</div>
                                    </div>
                                </div>
                        </div>
                    `;
                }
                
                // Show detailed data when available
                const seasonal = phase3.seasonal_analysis || {};
                const auroral = phase3.auroral_analysis || {};
                const storm = phase3.storm_prediction || {};
                const mufEvolution = phase3.muf_evolution || {};
                
                // Get actual values with fallbacks
                const currentSeason = seasonal.current_season || 'Unknown';
                const mufMultiplier = seasonal.seasonal_factors?.muf_multiplier?.toFixed(2) || '1.00';
                const activityLevel = auroral.activity_level?.replace('_', ' ').toUpperCase() || 'Unknown';
                const mufAdjustment = auroral.muf_adjustment?.toFixed(2) || '1.00';
                const stormProbability = storm.storm_probability?.replace('_', ' ').toUpperCase() || 'Unknown';
                const expectedImpact = storm.expected_impact?.toUpperCase() || 'Unknown';
                const phase2Muf = mufEvolution.phase2_muf?.toFixed(1) || 'N/A';
                const seasonalAdjusted = mufEvolution.seasonal_adjusted?.toFixed(1) || 'N/A';
                const auroralAdjusted = mufEvolution.auroral_adjusted?.toFixed(1) || 'N/A';
                const stormAdjusted = mufEvolution.storm_adjusted?.toFixed(1) || 'N/A';
                const finalPhase3Muf = mufEvolution.final_phase3_muf?.toFixed(1) || 'N/A';
                
                return `
                    <div class="space-y-4">
                        <!-- Seasonal Analysis -->
                                <div class="bg-gray-700 p-3 rounded-lg">
                            <div class="text-sm text-blue-300 font-semibold mb-2">Seasonal Patterns</div>
                            <div class="grid grid-cols-2 gap-3 text-xs">
                                <div>
                                    <div class="text-gray-400">Current Season</div>
                                    <div class="font-semibold text-white">` + currentSeason + `</div>
                                    </div>
                                <div>
                                    <div class="text-gray-400">MUF Multiplier</div>
                                    <div class="font-semibold ${seasonal.seasonal_factors?.muf_multiplier > 1 ? 'text-green-400' : 'text-red-400'}">
                                        ` + mufMultiplier + `x
                                </div>
                                        </div>
                                    </div>
                            ` + (seasonal.day_of_year_analysis?.event ? `
                                <div class="mt-2 p-2 bg-blue-900/20 rounded border-l-2 border-blue-500">
                                    <div class="text-xs text-blue-300 font-semibold">` + (seasonal.day_of_year_analysis.event || 'N/A') + `</div>
                                    <div class="text-xs text-gray-300">` + (seasonal.day_of_year_analysis.propagation_enhancement || 'N/A') + `</div>
                                    <div class="text-xs text-gray-400">Duration: ` + (seasonal.day_of_year_analysis.duration || 'N/A') + `</div>
                            </div>
                            ` : '') + `
                        </div>
                        
                        <!-- Auroral Activity -->
                                <div class="bg-gray-700 p-3 rounded-lg">
                            <div class="text-sm text-purple-300 font-semibold mb-2">Auroral Activity</div>
                            <div class="grid grid-cols-2 gap-3 text-xs">
                                <div>
                                    <div class="text-gray-400">Activity Level</div>
                                    <div class="font-semibold ` + (activityLevel === 'QUIET' ? 'text-green-400' : 
                                                               activityLevel === 'UNSETTLED' ? 'text-yellow-400' : 
                                                               activityLevel === 'MINOR STORM' ? 'text-orange-400' : 
                                                               activityLevel === 'STRONG STORM' ? 'text-red-400' : 'text-white') + `">
                                        ` + activityLevel + `
                                    </div>
                                    </div>
                                <div>
                                    <div class="text-gray-400">MUF Adjustment</div>
                                    <div class="font-semibold ` + (parseFloat(mufAdjustment) > 1 ? 'text-green-400' : 'text-red-400') + `">
                                        ` + mufAdjustment + `x
                                </div>
                                    </div>
                                </div>
                            <div class="mt-2 text-xs text-gray-300">
                                ` + (auroral.auroral_zone_effects?.replace('_', ' ').toUpperCase() || 'Normal conditions') + `
                                        </div>
                                    </div>
                                
                        <!-- Storm Prediction -->
                                    <div class="bg-gray-700 p-3 rounded-lg">
                            <div class="text-sm text-red-300 font-semibold mb-2">Storm Prediction</div>
                            <div class="grid grid-cols-2 gap-3 text-xs">
                                <div>
                                    <div class="text-gray-400">Storm Probability</div>
                                    <div class="font-semibold ` + (stormProbability === 'VERY LOW' ? 'text-green-400' : 
                                                               stormProbability === 'LOW' ? 'text-blue-400' : 
                                                               stormProbability === 'MODERATE' ? 'text-yellow-400' : 
                                                               stormProbability === 'HIGH' ? 'text-orange-400' : 'text-red-400') + `">
                                        ` + stormProbability + `
                                        </div>
                                    </div>
                                <div>
                                    <div class="text-gray-400">Expected Impact</div>
                                    <div class="font-semibold ` + (expectedImpact === 'MINIMAL' ? 'text-green-400' : 
                                                               expectedImpact === 'MINOR' ? 'text-yellow-400' : 
                                                               expectedImpact === 'MODERATE' ? 'text-orange-400' : 'text-red-400') + `">
                                        ` + expectedImpact + `
                                        </div>
                                    </div>
                            </div>
                            ` + (storm.warnings?.length > 0 ? `
                                <div class="mt-2 p-2 bg-red-900/20 rounded border-l-2 border-red-500">
                                    <div class="text-xs text-red-300 font-semibold mb-1">Warnings:</div>
                                    ` + storm.warnings.map(warning => `<div class="text-xs text-gray-300">• ` + warning + `</div>`).join('') + `
                        </div>
                            ` : '') + `
                </div>
                        
                        <!-- MUF Evolution -->
                        <div class="bg-gray-700 p-3 rounded-lg">
                            <div class="text-sm text-green-300 font-semibold mb-2">MUF Evolution (Phase 3)</div>
                            <div class="space-y-2 text-xs">
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Phase 2 MUF:</span>
                                    <span class="font-semibold text-white">` + phase2Muf + ` MHz</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Seasonal Adjusted:</span>
                                    <span class="font-semibold text-white">` + seasonalAdjusted + ` MHz</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Auroral Adjusted:</span>
                                    <span class="font-semibold text-white">` + auroralAdjusted + ` MHz</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Storm Adjusted:</span>
                                    <span class="font-semibold text-white">` + stormAdjusted + ` MHz</span>
                                </div>
                                <div class="border-t border-gray-600 pt-2 mt-2">
                                <div class="flex justify-between">
                                        <span class="text-gray-400 font-semibold">Final Phase 3 MUF:</span>
                                        <span class="font-semibold text-green-400 text-lg">` + finalPhase3Muf + ` MHz</span>
                                </div>
                                </div>
                            </div>
                        </div>
                                        </div>
                `;
            } catch (e) {
                console.error('Error creating Phase 3 intelligence:', e);
                return '<div class="text-red-400 text-sm">Error displaying Phase 3 data</div>';
            }
        }

        function updateExecutiveSummary(data) {
            const executiveSummaryDiv = document.getElementById('executive-summary');
            if (!executiveSummaryDiv || !data.propagation_summary) return;
            
            const summary = data.propagation_summary;
            const params = summary.propagation_parameters || {};
            const solarCycle = summary.solar_cycle || {};
            
            // Get Phase 3 advanced intelligence data
            const phase3 = summary.enhanced_data_sources?.ionospheric?.phase3_enhancements;
            const hasPhase3 = phase3 && (phase3.seasonal_analysis || phase3.auroral_analysis || phase3.storm_prediction);
            
            // Create a coherent executive summary
            const currentTime = summary.current_time || 'Unknown';
            const dayNight = summary.day_night || 'Unknown';
            const muf = params.muf || 'N/A';
            const quality = params.quality || 'Unknown';
            const bestBands = params.best_bands || [];
            const phase = solarCycle.phase || 'Unknown';
            
            safeSetHTML(executiveSummaryDiv, `
                <div class="space-y-4">
                    <!-- Current Status Overview -->
                    <div class="bg-gray-800 p-4 rounded-lg">
                        <div class="text-sm text-gray-400 mb-2">Current Status</div>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                                <span class="text-gray-400">Time:</span>
                                <span class="ml-2 font-semibold">${currentTime} (${dayNight})</span>
                        </div>
                            <div>
                                <span class="text-gray-400">MUF:</span>
                                <span class="ml-2 font-semibold">${muf} MHz</span>
                    </div>
                            <div>
                                <span class="text-gray-400">Quality:</span>
                                <span class="ml-2 font-semibold ${getPropagationQualityClass(quality)}">${quality}</span>
                </div>
                            <div>
                                <span class="text-gray-400">Solar Phase:</span>
                                <span class="ml-2 font-semibold">${phase}</span>
                </div>
                </div>
                </div>
                    
                    <!-- Key Findings -->
                    <div class="space-y-2">
                        <div class="text-sm text-gray-400 font-semibold">Key Findings:</div>
                        <div class="text-sm text-gray-300 space-y-1">
                            <div>• MUF is currently ${muf} MHz, indicating ${muf > 20 ? 'excellent' : muf > 15 ? 'good' : muf > 10 ? 'fair' : 'poor'} HF conditions</div>
                            <div>• Solar cycle is in ${phase.toLowerCase()} phase</div>
                            <div>• Best operating bands: ${bestBands.slice(0, 3).join(', ') || 'None identified'}</div>
                            <div>• Overall propagation quality: ${quality}</div>
                            ${hasPhase3 ? `
                            <div>• Advanced intelligence: Phase 3 analysis active with enhanced accuracy</div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- Advanced Intelligence Summary -->
                    ${hasPhase3 ? `
                    <div class="space-y-2">
                        <div class="text-sm text-gray-400 font-semibold">Advanced Intelligence:</div>
                        <div class="text-sm text-gray-300 space-y-1">
                            ${phase3.seasonal_analysis ? `
                            <div>• Seasonal factor: ${phase3.seasonal_analysis.current_season || 'N/A'} (${phase3.seasonal_analysis.seasonal_factors?.muf_multiplier || 1.0}x MUF multiplier)</div>
                            ` : ''}
                            ${phase3.auroral_analysis ? `
                            <div>• Auroral activity: ${phase3.auroral_analysis.activity_level || 'N/A'} (${phase3.auroral_analysis.muf_adjustment || 1.0}x MUF adjustment)</div>
                            ` : ''}
                            ${phase3.storm_prediction ? `
                            <div>• Storm impact: ${phase3.storm_prediction.overall_impact || 'N/A'} (${phase3.storm_prediction.recovery_time || 'N/A'} recovery)</div>
                            ` : ''}
                </div>
                    </div>
                    ` : ''}
                    
                    <!-- Outlook -->
                    <div class="space-y-2">
                        <div class="text-sm text-gray-400 font-semibold">Outlook:</div>
                        <div class="text-sm text-gray-300">
                            ${solarCycle.prediction || 'Conditions analysis in progress...'}
                        </div>
                    </div>
                </div>
            `);
        }

                function updateSolarCycleInfo(data) {
            if (!solarCycleDiv || !data.propagation_summary) return;
            
            console.log('Solar cycle data:', data.propagation_summary.solar_cycle);
            const solarCycle = data.propagation_summary.solar_cycle || {};
            
            safeSetHTML(solarCycleDiv, `
                <div class="space-y-4">
                    <!-- Current Status -->
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Phase:</span>
                            <span class="font-semibold">${solarCycle.phase || 'N/A'}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Position:</span>
                            <span class="font-semibold text-blue-300">${solarCycle.cycle_position || 'N/A'}</span>
                    </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">SFI:</span>
                            <span class="font-semibold">${solarCycle.sfi_value || 'N/A'}</span>
                </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Sunspots:</span>
                            <span class="font-semibold">${solarCycle.sunspots || 'N/A'}</span>
                    </div>
                </div>
                
                    <!-- Trend Analysis -->
                    <div class="space-y-2">
                        <div class="text-sm text-gray-400 font-semibold">Trend Analysis:</div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Direction:</span>
                            <span class="font-semibold ${solarCycle.sfi_trend === 'Strongly Rising' ? 'text-green-400' : solarCycle.sfi_trend === 'Rising' ? 'text-blue-400' : solarCycle.sfi_trend === 'Stable' ? 'text-yellow-400' : 'text-red-400'}">${solarCycle.sfi_trend || 'N/A'}</span>
                </div>
                        <div class="text-xs text-gray-300">
                            ${solarCycle.trend_description || 'No trend description available'}
                    </div>
                        </div>
                        
                    <!-- Prediction -->
                    <div class="space-y-2">
                        <div class="text-sm text-gray-400 font-semibold">HF Conditions Forecast:</div>
                        <div class="text-sm text-gray-300">
                            ${solarCycle.prediction || 'No prediction available'}
                        </div>
                        <div class="text-xs text-gray-400">
                            ${solarCycle.phase_description || 'No phase description available'}
                        </div>
                    </div>
                    
                    <!-- Calculation Method -->
                    <div class="text-xs text-gray-500 border-t border-gray-700 pt-2">
                        ${solarCycle.calculation_method || 'Calculation method not specified'}
                    </div>
                </div>
            `);
        }

        function updateRiskAssessment(data) {
            const riskAssessmentDiv = document.getElementById('risk-assessment');
            if (!riskAssessmentDiv || !data.propagation_summary) return;
            
            const summary = data.propagation_summary;
            const params = summary.propagation_parameters || {};
            const solarCycle = summary.solar_cycle || {};
            const aurora = summary.aurora_conditions || {};
            
            // Analyze risks based on current conditions
            const risks = [];
            const warnings = [];
            
            // Check geomagnetic activity
            const kIndex = data.solar_conditions?.k_index || 0;
            if (kIndex >= 6) {
                risks.push({
                    level: 'CRITICAL',
                    message: 'Severe geomagnetic storm - Avoid HF operation',
                    impact: 'Complete HF blackout likely',
                    recommendation: 'Use VHF/UHF for local contacts only'
                });
            } else if (kIndex >= 4) {
                risks.push({
                    level: 'HIGH',
                    message: 'Strong geomagnetic activity',
                    impact: 'HF propagation severely degraded',
                    recommendation: 'Focus on lower bands (80m, 40m)'
                });
            } else if (kIndex >= 2) {
                warnings.push({
                    level: 'MODERATE',
                    message: 'Elevated geomagnetic activity',
                    impact: 'HF conditions may be unstable',
                    recommendation: 'Monitor conditions, avoid higher bands'
                });
            }
            
            // Check solar flux
            const sfi = parseInt(data.solar_conditions?.sfi) || 0;
            if (sfi < 60) {
                risks.push({
                    level: 'HIGH',
                    message: 'Very low solar flux',
                    impact: 'Poor HF conditions across all bands',
                    recommendation: 'Focus on local contacts and lower bands'
                });
            }
            
            // Check aurora conditions
            const auroraValue = parseInt(data.solar_conditions?.aurora) || 0;
            if (auroraValue >= 5) {
                warnings.push({
                    level: 'MODERATE',
                    message: 'Auroral activity detected',
                    impact: 'HF propagation may be affected at high latitudes',
                    recommendation: 'Monitor conditions, expect unusual propagation'
                });
            }
            
            // Check X-ray flares
            const xray = data.solar_conditions?.xray || '';
            if (xray.startsWith('M') || xray.startsWith('X')) {
                risks.push({
                    level: 'HIGH',
                    message: 'Major solar flare detected',
                    impact: 'HF propagation may be disrupted',
                    recommendation: 'Monitor for blackout conditions, avoid critical communications'
                });
            }
            
            // Check sunspot activity
            const sunspots = parseInt(data.solar_conditions?.sunspots) || 0;
            if (sunspots < 20) {
                warnings.push({
                    level: 'MODERATE',
                    message: 'Low sunspot activity',
                    impact: 'Reduced HF propagation on higher bands',
                    recommendation: 'Focus on lower bands (40m, 80m) for reliable contacts'
                });
            }
            
            // If no risks or warnings, show positive status
            if (risks.length === 0 && warnings.length === 0) {
                safeSetHTML(riskAssessmentDiv, `
                    <div class="space-y-3">
                        <div class="bg-green-900/20 border border-green-500/30 p-4 rounded-lg">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-check-circle text-green-400 mr-2"></i>
                                <span class="font-semibold text-green-400">Low Risk Conditions</span>
                    </div>
                            <div class="text-sm text-green-300">
                                Current propagation conditions present minimal risks for HF operation.
                            </div>
                        </div>
                        
                        <!-- Solar Analysis Summary -->
                        <div class="bg-blue-900/20 border border-blue-500/30 p-4 rounded-lg">
                            <div class="text-sm text-blue-300 font-semibold mb-2">Solar Analysis Summary</div>
                            <div class="text-xs text-gray-300 space-y-1">
                                <div>• SFI ${sfi}: ${sfi >= 120 ? 'Favorable' : sfi >= 100 ? 'Moderate' : 'Limited'} HF conditions</div>
                                <div>• K-Index ${kIndex}: ${kIndex <= 2 ? 'Quiet' : kIndex <= 3 ? 'Unsettled' : 'Active'} geomagnetic conditions</div>
                                <div>• Aurora ${auroraValue}: ${auroraValue <= 2 ? 'Quiet' : auroraValue <= 4 ? 'Minor' : 'Active'} auroral activity</div>
                                <div>• Sunspots ${sunspots}: ${sunspots >= 50 ? 'Good' : sunspots >= 20 ? 'Moderate' : 'Low'} solar activity</div>
                                <div>• X-Ray: ${xray.startsWith('M') || xray.startsWith('X') ? 'Major flare' : xray.startsWith('C') ? 'Common flare' : 'Quiet'} conditions</div>
                        </div>
                    </div>
                </div>
                `);
                return;
            }
            
            // Display risks and warnings
            let riskHtml = '';
            
            if (risks.length > 0) {
                riskHtml += `
                    <div class="space-y-3 mb-4">
                        <div class="text-sm text-red-400 font-semibold">High Risk Conditions:</div>
                        ${risks.map(risk => `
                            <div class="bg-red-900/20 border border-red-500/30 p-3 rounded-lg">
                                <div class="flex items-center mb-2">
                                    <i class="fas fa-exclamation-triangle text-red-400 mr-2"></i>
                                    <span class="font-semibold text-red-400">${risk.level}</span>
                    </div>
                                <div class="text-sm text-red-300 mb-2">${risk.message}</div>
                                <div class="text-xs text-red-400 mb-1">Impact: ${risk.impact}</div>
                                <div class="text-xs text-orange-300">Recommendation: ${risk.recommendation}</div>
                            </div>
                        `).join('')}
                        </div>
                `;
            }
            
            // Add comprehensive solar analysis to risk display
            const solarAnalysis = `
                <div class="bg-blue-900/20 border border-blue-500/30 p-4 rounded-lg mt-4">
                    <div class="text-sm text-blue-300 font-semibold mb-2">Comprehensive Solar Analysis</div>
                    <div class="text-xs text-gray-300 space-y-1">
                        <div>• SFI ${sfi}: ${sfi >= 150 ? 'Excellent' : sfi >= 120 ? 'Good' : sfi >= 100 ? 'Moderate' : 'Poor'} HF conditions</div>
                        <div>• K-Index ${kIndex}: ${kIndex >= 6 ? 'Severe storm' : kIndex >= 4 ? 'Strong storm' : kIndex >= 2 ? 'Minor storm' : 'Quiet'} geomagnetic activity</div>
                        <div>• A-Index ${data.solar_conditions?.a_index || 'N/A'}: ${parseInt(data.solar_conditions?.a_index) >= 30 ? 'High' : parseInt(data.solar_conditions?.a_index) >= 15 ? 'Moderate' : 'Low'} activity</div>
                        <div>• Aurora ${auroraValue}: ${auroraValue >= 8 ? 'High' : auroraValue >= 5 ? 'Moderate' : auroraValue >= 3 ? 'Minor' : 'Quiet'} auroral activity</div>
                        <div>• Sunspots ${sunspots}: ${sunspots >= 100 ? 'High' : sunspots >= 50 ? 'Moderate' : 'Low'} solar activity</div>
                        <div>• X-Ray: ${xray.startsWith('M') || xray.startsWith('X') ? 'Major flare' : xray.startsWith('C') ? 'Common flare' : 'Quiet'} conditions</div>
                        </div>
                        </div>
            `;
            
            if (warnings.length > 0) {
                riskHtml += `
                    <div class="space-y-3">
                        <div class="text-sm text-yellow-400 font-semibold">Warnings:</div>
                        ${warnings.map(warning => `
                            <div class="bg-yellow-900/20 border border-yellow-500/30 p-3 rounded-lg">
                                <div class="flex items-center mb-2">
                                    <i class="fas fa-exclamation-circle text-yellow-400 mr-2"></i>
                                    <span class="font-semibold text-yellow-400">${warning.level}</span>
                                </div>
                                <div class="text-sm text-yellow-300 mb-2">${warning.message}</div>
                                <div class="text-xs text-yellow-400 mb-1">Impact: ${warning.impact}</div>
                                <div class="text-xs text-orange-300">Recommendation: ${warning.recommendation}</div>
                                </div>
                        `).join('')}
                </div>
            `;
            }
            
            // Combine risks, warnings, and solar analysis
            const finalHtml = riskHtml + solarAnalysis;
            safeSetHTML(riskAssessmentDiv, finalHtml);
        }

        // Main update function
        function updateAllUI(data) {
            console.log('Updating UI with data:', data);
            console.log('Propagation summary structure:', data.propagation_summary);
            
            updateTimestampAndLocation(data);
            updateSolarConditions(data);
            updatePropagationCurrent(data);
            updateBestBandsCurrent(data);
            updateBandConditions(data);
            updateWeatherConditions(data);
            updateExecutiveSummary(data);
            updateSolarCycleInfo(data);
            updateRecommendations(data);

            updateLiveActivity(data);
        }

        // Initialize UI when page loads
        document.addEventListener('DOMContentLoaded', function() {
            try {
                const dataElement = document.getElementById('data');
                if (dataElement && dataElement.textContent) {
                    const data = JSON.parse(dataElement.textContent);
                    console.log('Initial data loaded:', data);
                    updateAllUI(data);
                } else {
                    console.warn('No initial data found');
                }
            } catch (error) {
                console.error('Error parsing initial data:', error);
            }
        });

        // Live spots functionality
        function updateLiveActivity(data) {
            if (!summaryDiv || !tableBody) return;
            
            console.log('Live activity data:', data.live_activity);
            
            // Update loading status
            const loadingSpinner = document.getElementById('spots-loading');
            const statusSpan = document.getElementById('spots-status');
            
            if (data.live_activity && data.live_activity.spots && data.live_activity.spots.length > 0) {
                if (loadingSpinner) loadingSpinner.style.display = 'none';
                if (statusSpan) statusSpan.textContent = `${data.live_activity.spots.length} spots loaded`;
            } else {
                if (loadingSpinner) loadingSpinner.style.display = 'inline-block';
                if (statusSpan) statusSpan.textContent = 'Loading spots...';
            }
            
            // Update activity summary
            if (data.live_activity && data.live_activity.summary) {
                const summary = data.live_activity.summary;
                safeSetHTML(summaryDiv, `
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="data-card">
                            <div class="text-gray-400 font-body text-sm mb-2">Total Spots</div>
                            <div class="text-xl font-heading text-white">${summary.total_spots || 0}</div>
                            </div>
                        <div class="data-card">
                            <div class="text-gray-400 font-body text-sm mb-2">Active Bands</div>
                            <div class="text-xl font-heading text-white">${summary.active_bands || 0}</div>
                        </div>
                        <div class="data-card">
                            <div class="text-gray-400 font-body text-sm mb-2">Active Modes</div>
                            <div class="text-xl font-heading text-white">${summary.active_modes || 0}</div>
                    </div>
                        <div class="data-card">
                            <div class="text-gray-400 font-body text-sm mb-2">Active DXCC</div>
                            <div class="text-xl font-heading text-white">${summary.active_dxcc || 0}</div>
                    </div>
                </div>
                `);
            }
            
            // Update spots table
            if (data.live_activity && data.live_activity.spots && data.live_activity.spots.length > 0) {
                const spots = data.live_activity.spots;
                const spotsHtml = spots.slice(0, 20).map(spot => `
                    <tr class="hover:bg-gray-800">
                        <td class="px-4 py-2 text-sm">${spot.time || spot.timestamp || 'N/A'}</td>
                        <td class="px-4 py-2 font-mono">${spot.callsign || 'N/A'}</td>
                        <td class="px-4 py-2 text-sm">${spot.frequency || 'N/A'}</td>
                        <td class="px-4 py-2 text-sm">${spot.mode || 'N/A'}</td>
                        <td class="px-4 py-2 text-sm">${spot.dxcc || 'N/A'}</td>
                        <td class="px-4 py-2 text-sm">${spot.source || 'N/A'}</td>
                        <td class="px-4 py-2 text-sm text-gray-400">${spot.comment || ''}</td>
                    </tr>
                `).join('');
                
                safeSetHTML(tableBody, spotsHtml);
            } else {
                safeSetHTML(tableBody, `
                    <tr>
                        <td colspan="7" class="px-4 py-2 text-center text-gray-400">
                            No spots data available
                        </td>
                    </tr>
                `);
            }
        }

        // Utility functions
        function checkForUpdates() {
            console.log('Checking for updates...');
            // Implementation for update checking
        }

        function showFullChangelog() {
            console.log('Showing changelog...');
            // Implementation for changelog display
        }

        // Auto-refresh functionality
        let refreshInterval;
        
        function startAutoRefresh() {
            refreshInterval = setInterval(() => {
                // Refresh data every 5 minutes
                console.log('Auto-refreshing data...');
                // Implement data refresh logic here
            }, 5 * 60 * 1000);
        }

        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }

        // Start auto-refresh when page loads
        document.addEventListener('DOMContentLoaded', function() {
            startAutoRefresh();
        });

        // Stop auto-refresh when page is hidden
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                stopAutoRefresh();
            } else {
                startAutoRefresh();
            }
        });
    </script>
</body>
</html>