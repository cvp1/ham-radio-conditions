<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ham Radio Conditions</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .condition-good { color: #10B981; }
        .condition-fair { color: #F59E0B; }
        .condition-poor { color: #EF4444; }
        
        /* Icon colors and animations */
        .icon-solar { color: #F59E0B; }
        .icon-band { color: #3B82F6; }
        .icon-weather { color: #10B981; }
        .icon-dxcc { color: #8B5CF6; }
        .icon-spots { color: #EC4899; }
        
        .section-icon {
            transition: transform 0.2s ease-in-out;
        }
        .section-icon:hover {
            transform: scale(1.1);
        }

        /* Loading animation */
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 3px solid #EC4899;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- Hidden data element -->
    <script id="data" type="application/json">
        {{ data|tojson|safe }}
    </script>

    <div class="container mx-auto px-4 py-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-2">Ham Radio Conditions</h1>
            <p class="text-gray-400" id="timestamp"></p>
            <p class="text-gray-400" id="location"></p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Solar Conditions -->
            <div class="card rounded-lg p-6">
                <h2 class="text-2xl font-semibold mb-4">
                    <i class="fas fa-sun mr-2 section-icon icon-solar"></i>Solar Conditions
                </h2>
                <div id="solar-conditions" class="space-y-2"></div>
            </div>

            <!-- Band Conditions -->
            <div class="card rounded-lg p-6">
                <h2 class="text-2xl font-semibold mb-4">
                    <i class="fas fa-broadcast-tower mr-2 section-icon icon-band"></i>Band Conditions
                </h2>
                <div id="band-conditions" class="space-y-4"></div>
            </div>

            <!-- Weather Conditions -->
            <div class="card rounded-lg p-6">
                <h2 class="text-2xl font-semibold mb-4">
                    <i class="fas fa-cloud-sun mr-2 section-icon icon-weather"></i>Weather Conditions
                </h2>
                <div id="weather-conditions" class="space-y-2"></div>
            </div>

            <!-- DXCC Information -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">DXCC Information</h2>
                {% if data.dxcc_conditions %}
                    <div class="mb-6">
                        <h3 class="text-lg font-medium mb-2">Current Location</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-gray-600">Entity:</p>
                                <p class="font-medium">{{ data.dxcc_conditions.current_dxcc.name }}</p>
                            </div>
                            <div>
                                <p class="text-gray-600">Continent:</p>
                                <p class="font-medium">{{ data.dxcc_conditions.current_dxcc.continent }}</p>
                            </div>
                            <div>
                                <p class="text-gray-600">ITU Zone:</p>
                                <p class="font-medium">{{ data.dxcc_conditions.current_dxcc.itu_zone }}</p>
                            </div>
                            <div>
                                <p class="text-gray-600">CQ Zone:</p>
                                <p class="font-medium">{{ data.dxcc_conditions.current_dxcc.cq_zone }}</p>
                            </div>
                            <div>
                                <p class="text-gray-600">Prefixes:</p>
                                <p class="font-medium">{{ data.dxcc_conditions.current_dxcc.prefixes|join(', ') }}</p>
                            </div>
                            <div>
                                <p class="text-gray-600">Timezone:</p>
                                <p class="font-medium">{{ data.dxcc_conditions.current_dxcc.timezone }}</p>
                            </div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h3 class="text-lg font-medium mb-2">Nearby Entities</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="px-4 py-2 text-left">Entity</th>
                                        <th class="px-4 py-2 text-left">Distance</th>
                                        <th class="px-4 py-2 text-left">Continent</th>
                                        <th class="px-4 py-2 text-left">Prefixes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for entity in data.dxcc_conditions.nearby_dxcc %}
                                    <tr class="border-t">
                                        <td class="px-4 py-2">{{ entity.name }}</td>
                                        <td class="px-4 py-2">{{ entity.distance }} km</td>
                                        <td class="px-4 py-2">{{ entity.continent }}</td>
                                        <td class="px-4 py-2">{{ entity.prefixes|join(', ') }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-lg font-medium mb-2">Propagation Conditions</h3>
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <p class="text-gray-600">Best Bands:</p>
                                <p class="font-medium">{{ data.dxcc_conditions.propagation_conditions.best_bands|join(', ') }}</p>
                            </div>
                            <div>
                                <p class="text-gray-600">Best Times:</p>
                                <p class="font-medium">{{ data.dxcc_conditions.propagation_conditions.best_times|join(', ') }}</p>
                            </div>
                            <div>
                                <p class="text-gray-600">Best Directions:</p>
                                <p class="font-medium">{{ data.dxcc_conditions.propagation_conditions.best_directions|join(', ') }}</p>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <p class="text-gray-500">DXCC information not available</p>
                {% endif %}
            </div>

            <!-- Live Spots -->
            <div class="card rounded-lg p-6 lg:col-span-2">
                <h2 class="text-2xl font-semibold mb-4">
                    <i class="fas fa-broadcast-tower mr-2 section-icon icon-spots"></i>Live Spots
                    <span id="spots-loading" class="loading-spinner ml-2"></span>
                </h2>
                <div id="live-activity">
                    <div id="activity-summary" class="mb-4">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-gray-800 p-4 rounded-lg">
                                <div class="text-gray-400">Total Spots</div>
                                <div class="text-xl font-semibold">-</div>
                            </div>
                            <div class="bg-gray-800 p-4 rounded-lg">
                                <div class="text-gray-400">Active Bands</div>
                                <div class="text-xl font-semibold">-</div>
                            </div>
                            <div class="bg-gray-800 p-4 rounded-lg">
                                <div class="text-gray-400">Active Modes</div>
                                <div class="text-xl font-semibold">-</div>
                            </div>
                            <div class="bg-gray-800 p-4 rounded-lg">
                                <div class="text-gray-400">Active DXCC</div>
                                <div class="text-xl font-semibold">-</div>
                            </div>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead>
                                <tr class="text-left">
                                    <th class="px-4 py-2">Time</th>
                                    <th class="px-4 py-2">Callsign</th>
                                    <th class="px-4 py-2">Frequency</th>
                                    <th class="px-4 py-2">Mode</th>
                                    <th class="px-4 py-2">Band</th>
                                    <th class="px-4 py-2">DXCC</th>
                                    <th class="px-4 py-2">Source</th>
                                    <th class="px-4 py-2">Comment</th>
                                </tr>
                            </thead>
                            <tbody id="spots-table-body">
                                <tr>
                                    <td colspan="8" class="px-4 py-2 text-center text-gray-400">
                                        Loading spots data...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load initial conditions data immediately
        const initialData = JSON.parse(document.getElementById('data').textContent);
        updateConditionsUI(initialData);

        // Function to update conditions UI
        function updateConditionsUI(data) {
            // Update timestamp and location
            document.getElementById('timestamp').textContent = `Last Updated: ${data.timestamp}`;
            document.getElementById('location').textContent = `Location: ${data.location}`;

            // Update Solar Conditions
            const solarDiv = document.getElementById('solar-conditions');
            solarDiv.innerHTML = Object.entries(data.solar_conditions)
                .map(([key, value]) => `
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">${key.replace('_', ' ').toUpperCase()}</span>
                        <span class="font-semibold">${formatValue(key, value)}</span>
                    </div>
                `).join('');

            // Update Band Conditions
            const bandDiv = document.getElementById('band-conditions');
            bandDiv.innerHTML = Object.entries(data.band_conditions)
                .map(([band, conditions]) => `
                    <div class="mb-4">
                        <h3 class="text-lg font-semibold mb-2">${band}</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <span class="text-gray-400">Day:</span>
                                <span class="ml-2 ${updateConditionClass(conditions.day)}">${conditions.day}</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Night:</span>
                                <span class="ml-2 ${updateConditionClass(conditions.night)}">${conditions.night}</span>
                            </div>
                        </div>
                    </div>
                `).join('');

            // Update Weather Conditions
            const weatherDiv = document.getElementById('weather-conditions');
            if (data.weather_conditions) {
                weatherDiv.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">CALLSIGN</span>
                        <span class="font-semibold">${data.callsign || 'N/A'}</span>
                    </div>
                    ${Object.entries(data.weather_conditions)
                        .filter(([key]) => key !== 'source')
                        .map(([key, value]) => `
                            <div class="flex justify-between items-center">
                                <span class="text-gray-400">${key.replace('_', ' ').toUpperCase()}</span>
                                <span class="font-semibold">${value}</span>
                            </div>
                        `).join('')}
                `;
            } else {
                weatherDiv.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">CALLSIGN</span>
                        <span class="font-semibold">${data.callsign || 'N/A'}</span>
                    </div>
                    <p class="text-gray-400">Weather data not available</p>
                `;
            }

            // Update DXCC Conditions
            const dxccDiv = document.getElementById('dxcc-conditions');
            if (data.dxcc_conditions) {
                let dxccHtml = '';
                
                // Current DXCC Entity
                if (data.dxcc_conditions.current_dxcc) {
                    const current = data.dxcc_conditions.current_dxcc;
                    dxccHtml += `
                        <div class="mb-4">
                            <h3 class="text-lg font-semibold mb-2">Current DXCC Entity</h3>
                            <div class="grid grid-cols-2 gap-2">
                                <div class="text-gray-400">Name:</div>
                                <div>${current.name}</div>
                                <div class="text-gray-400">Continent:</div>
                                <div>${current.continent}</div>
                                <div class="text-gray-400">ITU Zone:</div>
                                <div>${current.itu_zone}</div>
                                <div class="text-gray-400">CQ Zone:</div>
                                <div>${current.cq_zone}</div>
                            </div>
                        </div>
                    `;
                }

                // Nearby DXCC Entities
                if (data.dxcc_conditions.nearby_dxcc && data.dxcc_conditions.nearby_dxcc.length > 0) {
                    dxccHtml += `
                        <div class="mb-4">
                            <h3 class="text-lg font-semibold mb-2">Nearby DXCC Entities</h3>
                            <div class="space-y-2">
                                ${data.dxcc_conditions.nearby_dxcc
                                    .filter(entity => entity !== null)
                                    .map(entity => `
                                        <div class="grid grid-cols-2 gap-2">
                                            <div class="text-gray-400">Name:</div>
                                            <div>${entity.name}</div>
                                            <div class="text-gray-400">Continent:</div>
                                            <div>${entity.continent}</div>
                                            <div class="text-gray-400">ITU Zone:</div>
                                            <div>${entity.itu_zone}</div>
                                            <div class="text-gray-400">CQ Zone:</div>
                                            <div>${entity.cq_zone}</div>
                                        </div>
                                    `).join('')}
                            </div>
                        </div>
                    `;
                }

                // Propagation Conditions
                if (data.dxcc_conditions.propagation_conditions) {
                    const prop = data.dxcc_conditions.propagation_conditions;
                    dxccHtml += `
                        <div class="mb-4">
                            <h3 class="text-lg font-semibold mb-2">Propagation Conditions</h3>
                            <div class="space-y-2">
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="text-gray-400">Best Bands:</div>
                                    <div>${prop.best_bands.join(', ')}</div>
                                    <div class="text-gray-400">Best Times:</div>
                                    <div>${prop.best_times.join(', ')}</div>
                                    <div class="text-gray-400">Best Directions:</div>
                                    <div>${prop.best_directions.join(', ')}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                dxccDiv.innerHTML = dxccHtml;
            } else {
                dxccDiv.innerHTML = '<p class="text-gray-400">DXCC data not available</p>';
            }
        }

        function updateConditionClass(condition) {
            condition = condition.toLowerCase();
            if (condition.includes('good')) return 'condition-good';
            if (condition.includes('fair')) return 'condition-fair';
            if (condition.includes('poor')) return 'condition-poor';
            return '';
        }

        function formatValue(key, value) {
            if (key === 'sfi') return `${value} SFI`;
            if (key === 'a_index') return `A-Index: ${value}`;
            if (key === 'k_index') return `K-Index: ${value}`;
            return value;
        }

        // Function to fetch spots data
        async function fetchSpots() {
            const loadingSpinner = document.getElementById('spots-loading');
            loadingSpinner.style.display = 'inline-block';
            
            try {
                const response = await fetch('/api/spots');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const spotsData = await response.json();
                updateSpotsUI(spotsData);
            } catch (error) {
                console.error('Error fetching spots:', error);
                document.getElementById('live-activity').innerHTML = `
                    <div class="text-red-500">
                        Error loading live spots: ${error.message}
                    </div>
                `;
            } finally {
                loadingSpinner.style.display = 'none';
            }
        }

        // Function to update spots UI
        function updateSpotsUI(data) {
            const activityDiv = document.getElementById('live-activity');
            if (!activityDiv) return;
            
            // Update summary
            const summaryDiv = document.getElementById('activity-summary');
            if (summaryDiv && data.summary) {
                const summaryHtml = `
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <div class="text-gray-400">Total Spots</div>
                            <div class="text-xl font-semibold">${data.summary.total_spots || 0}</div>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <div class="text-gray-400">Active Bands</div>
                            <div class="text-xl font-semibold">${data.summary.active_bands?.join(', ') || 'None'}</div>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <div class="text-gray-400">Active Modes</div>
                            <div class="text-xl font-semibold">${data.summary.active_modes?.join(', ') || 'None'}</div>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <div class="text-gray-400">Active DXCC</div>
                            <div class="text-xl font-semibold">${data.summary.active_dxcc?.length || 0}</div>
                        </div>
                    </div>
                `;
                summaryDiv.innerHTML = summaryHtml;
            }

            // Update spots table
            const tableBody = document.getElementById('spots-table-body');
            if (tableBody) {
                if (data.spots && data.spots.length > 0) {
                    tableBody.innerHTML = data.spots.map(spot => `
                        <tr class="border-t border-gray-700 hover:bg-gray-800">
                            <td class="px-4 py-2">${spot.timestamp || '-'}</td>
                            <td class="px-4 py-2 font-mono">${spot.callsign || '-'}</td>
                            <td class="px-4 py-2 font-mono">${spot.frequency || '-'}</td>
                            <td class="px-4 py-2">${spot.mode || '-'}</td>
                            <td class="px-4 py-2">${spot.band || '-'}</td>
                            <td class="px-4 py-2">${spot.dxcc || '-'}</td>
                            <td class="px-4 py-2">
                                <span class="px-2 py-1 rounded text-sm ${spot.source?.includes('RBN') ? 'bg-blue-900 text-blue-200' : 'bg-purple-900 text-purple-200'}">
                                    ${spot.source || '-'}
                                </span>
                            </td>
                            <td class="px-4 py-2 text-gray-400">${spot.comment || '-'}</td>
                        </tr>
                    `).join('');
                } else {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="8" class="px-4 py-2 text-center text-gray-400">
                                No spots available at this time
                            </td>
                        </tr>
                    `;
                }
            }
        }

        // Initial spots load
        fetchSpots();

        // Update spots every 5 minutes
        setInterval(fetchSpots, 5 * 60 * 1000);
    </script>
</body>
</html> 